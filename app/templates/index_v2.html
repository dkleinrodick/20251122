<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- Primary SEO -->
    <title>WildFares | The 100% Free GoWild! Search & Map</title>
    <meta name="description" content="Stop paying subscription fees for flight search. WildFares is the advanced, completely free tool for Frontier's GoWild! Pass. Visual maps, multi-hop routing, and real-time inventory.">
    <meta name="keywords" content="Frontier GoWild Pass, free flight finder, wildfares, Frontier Airlines map, all-you-can-fly, no subscription search, visual flight search">
    <meta name="author" content="WildFares">
    
    <!-- Open Graph / Facebook / iMessage -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://wildfares.com/">
    <meta property="og:site_name" content="WildFares">
    <meta property="og:title" content="WildFares - The Free GoWild! Search Engine">
    <meta property="og:description" content="Don't pay for what should be free. The ultimate visual search tool for Frontier's All-You-Can-Fly Pass. Real-time inventory, zero cost.">
    
    <!-- Social Image: Upload a 1200x630 PNG named 'social-card.png' to app/static/ for best results -->
    <meta property="og:image" content="https://wildfares.com/static/social-card.png">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:image:alt" content="WildFares Dashboard">

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://wildfares.com/">
    <meta property="twitter:title" content="WildFares - The Free GoWild! Search Engine">
    <meta property="twitter:description" content="Don't pay for what should be free. The ultimate visual search tool for Frontier's All-You-Can-Fly Pass.">
    <meta property="twitter:image" content="https://wildfares.com/static/social-card.png">

    <!-- iOS / Apple Icons -->
    <link rel="apple-touch-icon" href="/static/logo.png">
    <meta name="apple-mobile-web-app-title" content="WildFares">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <!-- JSON-LD Structured Data -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebApplication",
      "name": "WildFares",
      "applicationCategory": "TravelApplication",
      "operatingSystem": "Any",
      "browserRequirements": "Requires JavaScript",
      "offers": {
        "@type": "Offer",
        "price": "0",
        "priceCurrency": "USD"
      },
      "description": "A completely free, advanced search engine for Frontier Airlines GoWild! Pass holders. Features visual mapping and multi-hop routing without subscription fees.",
      "featureList": "Visual Map, Multi-Hop Routing, Real-Time Availability, Zero Cost"
    }
    </script>

    <link rel="icon" type="image/png" href="/static/logo.png">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    
    <!-- Axios -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <!-- Leaflet (Map) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Space+Grotesk:wght@400;500;700&display=swap" rel="stylesheet">

    <!-- Configuration -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        // Professional "Aero" Blue Palette
                        brand: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            200: '#bae6fd',
                            300: '#7dd3fc',
                            400: '#38bdf8',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            700: '#0369a1', 
                            800: '#075985',
                            900: '#0c4a6e', // Primary Dark
                            950: '#082f49',
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        display: ['Space Grotesk', 'sans-serif'],
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-out',
                        'slide-up': 'slideUp 0.5s ease-out',
                        'slide-in-right': 'slideInRight 0.3s ease-out',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(20px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        },
                        slideInRight: {
                            '0%': { transform: 'translateX(100%)' },
                            '100%': { transform: 'translateX(0)' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        [v-cloak] { display: none !important; }
        html { overflow-x: hidden; }
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; overflow-x: hidden; }
        h1, h2, h3, h4, h5, h6 { font-family: 'Space Grotesk', sans-serif; }

        /* Map - Keep it simple */
        #map {
            width: 100%;
            height: 100%;
        }

        /* Hero Background */
        .hero-bg {
            /* High quality travel image */
            background-image: url('https://images.unsplash.com/photo-1436491865332-7a61a109cc05?q=80&w=2074&auto=format&fit=crop');
            background-size: cover;
            background-position: center;
            position: absolute;
            inset: 0;
            z-index: 0;
        }
        
        .hero-overlay {
            background: linear-gradient(to bottom, rgba(8, 47, 73, 0.7), rgba(15, 23, 42, 0.9));
            position: absolute;
            inset: 0;
            z-index: 1;
        }

        /* Glass Effect */
        .glass-panel {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.8);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.15);
        }
        
        .glass-nav {
            background: rgba(12, 74, 110, 0.9);
            backdrop-filter: blur(10px);
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        /* Custom Sliders (Single & Dual) */
        .range-slider { position: relative; height: 20px; width: 100%; }
        
        input[type=range].custom-range,
        .range-slider input[type=range] {
            -webkit-appearance: none;
            appearance: none;
            background: transparent;
            cursor: pointer;
        }

        .range-slider input[type=range] {
            position: absolute;
            pointer-events: none;
            z-index: 20;
            height: 100%;
            width: 100%;
        }

        /* Thumbs */
        input[type=range].custom-range::-webkit-slider-thumb,
        .range-slider input[type=range]::-webkit-slider-thumb {
            pointer-events: auto;
            -webkit-appearance: none;
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: #0ea5e9;
            cursor: pointer;
            box-shadow: 0 0 2px rgba(0,0,0,0.2);
            margin-top: -6px;
        }
        .range-slider input[type=range]::-webkit-slider-thumb { margin-top: 0; }

        input[type=range].custom-range::-moz-range-thumb,
        .range-slider input[type=range]::-moz-range-thumb {
            pointer-events: auto;
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: #0ea5e9;
            cursor: pointer;
            border: none;
            box-shadow: 0 0 2px rgba(0,0,0,0.2);
        }

        /* Single Slider Track */
        input[type=range].custom-range::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            background: #e2e8f0;
            border-radius: 2px;
        }
        input[type=range].custom-range::-moz-range-track {
            width: 100%;
            height: 4px;
            background: #e2e8f0;
            border-radius: 2px;
        }
    </style>
</head>
<body class="text-slate-800 antialiased min-h-screen flex flex-col">

    <div id="app" class="flex-grow flex flex-col relative" v-cloak>
        {% raw %}

        <!-- Navbar -->
        <nav class="fixed w-full z-50 transition-all duration-300 border-b" :class="scrolled || mobileMenuOpen ? 'glass-nav py-3 shadow-lg border-white/10' : 'bg-transparent py-6 border-transparent'">
            <div class="container mx-auto px-6 flex justify-between items-center relative z-50">
                <div class="flex items-center gap-3 group cursor-pointer" @click="window.scrollTo(0,0)">
                    <img src="/static/logo.png" alt="WildFares" class="w-10 h-10 rounded-xl shadow-lg shadow-brand-500/30 group-hover:scale-105 transition-transform">
                    <span class="font-display font-bold text-2xl tracking-tight text-white group-hover:text-brand-200 transition-colors">WildFares</span>
                </div>
                
                <!-- Desktop Links -->
                <div class="hidden md:flex items-center gap-8 text-sm font-semibold text-white/90">
                    <a href="/features" class="hover:text-brand-300 transition">Features</a>
                    
                </div>

                <!-- Mobile Toggle -->
                <button @click="mobileMenuOpen = !mobileMenuOpen" class="md:hidden text-white text-2xl p-2 focus:outline-none">
                    <i :class="mobileMenuOpen ? 'ph-x' : 'ph-list'" class="ph transition-all duration-300"></i>
                </button>
            </div>

            <!-- Mobile Menu -->
            <div v-if="mobileMenuOpen" class="absolute top-full left-0 w-full bg-brand-950 border-t border-brand-800 shadow-2xl animate-fade-in md:hidden" style="z-index: 1000;">
                <div class="flex flex-col p-6 space-y-4">
                    <a href="/features" class="text-brand-100 font-bold text-lg py-2 px-4 rounded-lg hover:bg-white/5">Features</a>
                    <button @click="toggleDesktopMode" class="text-left text-brand-100 font-bold text-lg py-2 px-4 rounded-lg hover:bg-white/5 flex items-center gap-2">
                        <i :class="forceDesktop ? 'ph-device-mobile' : 'ph-desktop'" class="ph"></i>
                        {{ forceDesktop ? 'Switch to Mobile View' : 'Request Desktop Site' }}
                    </button>
                </div>
            </div>
        </nav>

        <!-- Hero Header -->
        <div class="relative w-full transition-all duration-700 ease-out" :class="hasSearched ? 'h-[40vh] min-h-[400px]' : 'h-[85vh] min-h-[600px]'">
            <div class="hero-bg"></div>
            <div class="hero-overlay"></div>

            <div class="relative z-10 container mx-auto px-6 h-full flex flex-col justify-center items-center text-center text-white pb-20 md:pb-32">
                <div v-if="!hasSearched" class="animate-slide-up max-w-4xl">
                    <div class="hidden md:inline-flex items-center gap-2 px-4 py-1.5 rounded-full bg-white/10 border border-white/20 backdrop-blur-md text-brand-200 text-xs font-bold uppercase tracking-widest mb-8 shadow-2xl">
                        <span class="w-2 h-2 rounded-full bg-brand-400 animate-pulse"></span>
                        The Unofficial GoWild! Companion
                    </div>
                    <h1 class="text-5xl md:text-7xl font-bold mb-6 leading-tight tracking-tight">
                        Unlock the World.<br>
                        <span class="text-transparent bg-clip-text bg-gradient-to-r from-brand-300 to-white">Embrace the Chaos.</span>
                    </h1>
                    <p class="text-lg md:text-xl text-slate-300 max-w-2xl mx-auto leading-relaxed font-light mb-10">
                        Visual search, multi-hop routing, and real-time availability for Frontier's all-you-can-fly pass.
                    </p>
                </div>
            </div>
        </div>

        <!-- Main Application Container -->
        <div class="relative z-20 -mt-32 md:-mt-48 container mx-auto px-4" :class="!forceDesktop ? 'pb-32' : 'pb-20'">
            
            <!-- Search Widget -->
            <div class="glass-panel rounded-3xl p-1 max-w-7xl mx-auto transition-all duration-500 shadow-2xl mb-4 md:mb-0">
                
                <!-- Tab Navigation (Desktop or Forced) -->
                <div :class="forceDesktop ? 'flex' : 'hidden md:flex'" class="bg-slate-100/50 rounded-2xl p-1">
                    <button v-for="tab in tabs" :key="tab.id" 
                        @click="currentTab = tab.id" 
                        :class="currentTab === tab.id ? 'bg-white text-brand-700 shadow-sm ring-1 ring-black/5' : 'text-slate-500 hover:text-slate-700 hover:bg-slate-200/50'"
                        class="flex-1 py-4 rounded-xl text-sm font-bold transition flex flex-col md:flex-row justify-center items-center gap-2 relative group">
                        <i :class="['ph text-xl mb-1 md:mb-0', tab.icon]"></i>
                        <span>{{ tab.label }}</span>
                    </button>
                </div>

                <!-- Search Inputs -->
                <div class="p-6 md:p-8">
                    <div class="grid grid-cols-1 md:grid-cols-12 gap-8 items-end">



                        <!-- ORIGIN INPUT -->
                        <div :class="currentTab === 'explore' || currentTab === 'daytrip' ? 'md:col-span-4' : 'md:col-span-3'" class="relative z-50" v-click-outside="() => showOriginDropdown = false">
                            <div class="flex justify-between items-end mb-2 h-6 ml-1">
                                <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider">
                                    {{ currentTab === 'explore' ? (exploreMode === 'origin' ? 'Departing From' : 'Arriving To') : 'Origin' }}
                                </label>
                                <button v-if="currentTab === 'explore'" @click="exploreMode = exploreMode === 'origin' ? 'destination' : 'origin'" class="text-[10px] font-bold text-brand-600 hover:text-brand-700 bg-brand-50 px-2 py-0.5 rounded cursor-pointer transition">
                                    {{ exploreMode === 'origin' ? 'Switch to Incoming' : 'Switch to Outgoing' }}
                                </button>
                            </div>
                            <div class="group bg-white border border-slate-200 focus-within:border-brand-500 focus-within:ring-4 focus-within:ring-brand-500/10 rounded-2xl flex items-center px-4 py-3.5 transition-all shadow-sm h-[3.5rem] md:mr-4">
                                <i :class="currentTab === 'explore' && exploreMode === 'destination' ? 'ph-airplane-landing' : 'ph-airplane-takeoff'" class="ph text-slate-400 text-xl mr-3 group-focus-within:text-brand-500"></i>
                                <input type="text" v-model="search.origin" @input="filterAirports('origin')" @focus="showOriginDropdown = true" @blur="validateInput('origin')"
                                    placeholder="City or Code"
                                    class="w-full bg-transparent outline-none font-bold text-slate-800 placeholder:text-slate-300 uppercase tracking-wide">
                                <button v-if="search.origin" @click="search.origin = ''; filterAirports('origin')" class="text-slate-300 hover:text-red-400"><i class="ph ph-x-circle-fill text-xl"></i></button>
                            </div>

                            <!-- ABSOLUTE SWAP BUTTON -->
                            <div v-if="currentTab === 'oneway' || currentTab === 'builder'" class="absolute top-1/2 -right-9 z-30 hidden md:flex items-center justify-center mt-3 transform -translate-y-1/2">
                                <button @click="swapAirports" class="w-10 h-10 rounded-full bg-white text-slate-400 hover:text-brand-600 border border-slate-200 hover:border-brand-300 transition-all shadow-sm flex items-center justify-center active:scale-90">
                                    <i class="ph ph-arrows-left-right text-lg"></i>
                                </button>
                            </div>

                            <!-- Dropdown -->
                            <div v-if="showOriginDropdown && filteredOrigins.length" class="absolute top-full left-0 w-full bg-white border border-slate-100 rounded-xl shadow-xl mt-2 max-h-64 overflow-y-auto z-50 py-2 animate-fade-in">
                                <div v-for="ap in filteredOrigins" :key="ap.code" @click="selectAirport('origin', ap)"
                                     class="px-4 py-3 hover:bg-brand-50 cursor-pointer flex justify-between items-center border-b border-slate-50 last:border-0 group">
                                    <div>
                                        <div class="font-bold text-slate-800 group-hover:text-brand-700">{{ ap.city }}</div>
                                        <div class="text-xs text-slate-400">{{ ap.name }}</div>
                                    </div>
                                    <span class="font-mono font-bold text-xs bg-slate-100 text-slate-500 px-2 py-1 rounded group-hover:bg-brand-200 group-hover:text-brand-800">{{ ap.code }}</span>
                                </div>
                            </div>
                        </div>

                        <!-- SWAP BUTTON (Removed for Equal Width Layout) -->

                        <!-- DESTINATION INPUT -->
                        <div v-if="currentTab === 'oneway' || currentTab === 'builder'" class="md:col-span-3 relative">
                            <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2 ml-1 md:ml-5 flex justify-between">
                                <span>Destination</span>
                            </label>

                            <!-- Mode: Anywhere (Default Day Trip) -->
                            <div v-if="currentTab === 'daytrip' && dayTripMode === 'anywhere'" class="relative group">
                                <div class="absolute -inset-0.5 bg-gradient-to-r from-brand-400 to-cyan-300 rounded-2xl opacity-20 group-hover:opacity-40 transition duration-500 blur-sm"></div>
                                <div class="relative bg-white border border-slate-100 rounded-2xl flex items-center px-4 py-3.5 w-full shadow-sm">
                                    <div class="w-8 h-8 rounded-full bg-brand-50 flex items-center justify-center text-brand-600 mr-3">
                                        <i class="ph ph-globe-hemisphere-west text-lg animate-pulse"></i>
                                    </div>
                                    <div class="flex-1">
                                        <div class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Destination</div>
                                        <div class="font-bold text-slate-800 text-sm">Everywhere</div>
                                    </div>
                                    <button @click="dayTripMode = 'specific'" class="ml-2 px-3 py-1.5 rounded-lg bg-slate-50 hover:bg-slate-100 border border-slate-200 text-slate-500 text-xs font-bold transition flex items-center gap-1">
                                        <i class="ph ph-pencil-simple"></i> Edit
                                    </button>
                                </div>
                            </div>

                            <!-- Mode: Specific (Input) -->
                            <div v-else class="relative" v-click-outside="() => showDestDropdown = false">
                                <!-- Explore Static Box (Tab=Explore) -->
                                <div v-if="currentTab === 'explore' && !search.dest" 
                                     @click="focusDest"
                                     class="bg-slate-50 border border-slate-200 border-dashed rounded-2xl flex items-center px-4 py-3.5 text-slate-400 cursor-pointer hover:bg-slate-100 hover:border-slate-300 transition">
                                    <i class="ph ph-globe-hemisphere-west text-xl mr-3"></i>
                                    <span class="font-medium italic">Anywhere in the network</span>
                                </div>

                                <!-- Standard Input -->
                                <div v-else class="group bg-white border border-slate-200 focus-within:border-brand-500 focus-within:ring-4 focus-within:ring-brand-500/10 rounded-2xl flex items-center px-4 py-3.5 transition-all md:ml-4">
                                    <i class="ph ph-airplane-landing text-slate-400 text-xl mr-3 group-focus-within:text-brand-500"></i>
                                    <input ref="destInput" type="text" v-model="search.dest" @input="filterAirports('dest')" @focus="showDestDropdown = true" @blur="validateInput('dest')"
                                        placeholder="City or Code"
                                        class="w-full bg-transparent outline-none font-bold text-slate-800 placeholder:text-slate-300 uppercase tracking-wide">
                                    <button v-if="search.dest" @click="search.dest = ''; filterAirports('dest')" class="text-slate-300 hover:text-red-400"><i class="ph ph-x-circle-fill text-xl"></i></button>
                                </div>

                                <!-- Dropdown -->
                                <div v-if="showDestDropdown && filteredDests.length" class="absolute top-full left-0 w-full bg-white border border-slate-100 rounded-xl shadow-xl mt-2 max-h-64 overflow-y-auto z-50 py-2 animate-fade-in">
                                    <div v-for="ap in filteredDests" :key="ap.code" @click="selectAirport('dest', ap)" 
                                         class="px-4 py-3 hover:bg-brand-50 cursor-pointer flex justify-between items-center border-b border-slate-50 last:border-0 group">
                                        <div>
                                            <div class="font-bold text-slate-800 group-hover:text-brand-700">{{ ap.city }}</div>
                                            <div class="text-xs text-slate-400">{{ ap.name }}</div>
                                        </div>
                                        <span class="font-mono font-bold text-xs bg-slate-100 text-slate-500 px-2 py-1 rounded group-hover:bg-brand-200 group-hover:text-brand-800">{{ ap.code }}</span>
                                    </div>
                                </div>

                                <!-- Back to Anywhere Link (DayTrip Specific Only) -->
                                <div v-if="currentTab === 'daytrip' && dayTripMode === 'specific'" class="mt-2 text-right">
                                    <button @click="dayTripMode = 'anywhere'" class="text-xs font-bold text-slate-400 hover:text-brand-600 transition">
                                        Switch back to Explore Anywhere
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- DATE INPUT -->
                        <div :class="currentTab === 'explore' || currentTab === 'daytrip' ? 'md:col-span-4' : 'md:col-span-3'" class="relative" v-click-outside="() => showDateDropdown = false">
                            <div class="flex justify-between items-end mb-2 h-6">
                                <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider">Departing</label>
                            </div>
                            <div @click="showDateDropdown = !showDateDropdown" 
                                class="bg-white border border-slate-200 hover:border-brand-300 rounded-2xl flex items-center px-4 py-3.5 relative cursor-pointer transition-all shadow-sm group">
                                <i class="ph ph-calendar-blank text-slate-400 text-xl mr-3 group-hover:text-brand-500"></i>
                                <div class="font-bold text-slate-800 flex-1 truncate">
                                    {{ dateOptions.find(o => o.value === search.date)?.label || 'Select Date' }}<span v-if="search.origin" class="text-brand-500">*</span>
                                    <span v-if="dateOptions.find(o => o.value === search.date)?.short" class="font-mono font-normal text-slate-400 ml-1">({{ dateOptions.find(o => o.value === search.date)?.short }})</span>
                                </div>
                                <i class="ph ph-caret-down text-slate-400 transition-transform duration-300" :class="showDateDropdown ? 'rotate-180' : ''"></i>
                            </div>
                            
                            <!-- Custom Dropdown -->
                            <div v-if="showDateDropdown" class="absolute top-full left-0 w-full bg-white border border-slate-100 rounded-xl shadow-xl mt-2 z-50 py-2 animate-fade-in max-h-64 overflow-y-auto">
                                <div v-for="opt in dateOptions" :key="opt.value" 
                                     @click="search.date = opt.value; showDateDropdown = false" 
                                     class="px-4 py-3 hover:bg-brand-50 cursor-pointer flex items-center justify-between group">
                                    <span class="font-bold text-slate-700 group-hover:text-brand-700">
                                        {{ opt.label }}<span v-if="search.origin" class="text-brand-500">*</span>
                                    </span>
                                    <span class="text-xs text-slate-400 font-mono">{{ opt.short }}</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- TRAVELERS INPUT -->
                        <div :class="currentTab === 'explore' || currentTab === 'daytrip' ? 'md:col-span-4' : 'md:col-span-3'" class="relative" v-click-outside="() => showPassengerMenu = false">
                            <div class="flex justify-between items-end mb-2 h-6">
                                <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider">Travelers</label>
                                <!-- Set Destination Removed -->
                            </div>
                            <div @click="showPassengerMenu = !showPassengerMenu" 
                                 class="bg-white border border-slate-200 hover:border-brand-300 rounded-2xl flex items-center px-4 py-3.5 relative cursor-pointer transition-all shadow-sm group h-[3.5rem]">
                                <i class="ph ph-users text-slate-400 text-xl mr-3 group-hover:text-brand-500"></i>
                                <div class="font-bold text-slate-800 flex-1 truncate">
                                    {{ passengers.adults === 1 && passengers.kids.length === 0 ? '1 Adult' : totalPassengers + ' Travelers' }}
                                </div>
                                <i class="ph ph-caret-down text-slate-400 transition-transform duration-300" :class="showPassengerMenu ? 'rotate-180' : ''"></i>
                            </div>
                            <!-- Dropdown -->
                            <div v-if="showPassengerMenu" class="absolute top-full right-0 w-72 bg-white border border-slate-100 rounded-xl shadow-xl mt-2 z-50 p-4 animate-fade-in">
                                <div class="flex justify-between items-center mb-4">
                                    <div><div class="font-bold text-slate-800">Adults</div><div class="text-xs text-slate-400">Age 15+</div></div>
                                    <div class="flex items-center gap-3">
                                        <button @click.stop="removeAdult" :disabled="passengers.adults <= 1" class="w-8 h-8 rounded-full bg-slate-100 text-slate-600 flex items-center justify-center hover:bg-slate-200 disabled:opacity-50 transition"><i class="ph-bold ph-minus"></i></button>
                                        <span class="font-bold text-slate-800 w-4 text-center">{{ passengers.adults }}</span>
                                        <button @click.stop="addAdult" :disabled="totalPassengers >= 9" class="w-8 h-8 rounded-full bg-slate-100 text-slate-600 flex items-center justify-center hover:bg-slate-200 disabled:opacity-50 transition"><i class="ph-bold ph-plus"></i></button>
                                    </div>
                                </div>
                                <div class="flex justify-between items-center mb-2">
                                    <div><div class="font-bold text-slate-800">Children</div><div class="text-xs text-slate-400">Age 2-14</div></div>
                                    <div class="flex items-center gap-3">
                                        <button @click.stop="removeKid(idx)" :disabled="passengers.kids.length === 0" class="w-8 h-8 rounded-full bg-slate-100 text-slate-600 flex items-center justify-center hover:bg-slate-200 disabled:opacity-50 transition"><i class="ph-bold ph-minus"></i></button>
                                        <span class="font-bold text-slate-800 w-4 text-center">{{ passengers.kids.length }}</span>
                                        <button @click.stop="addKid" :disabled="totalPassengers >= 9" class="w-8 h-8 rounded-full bg-slate-100 text-slate-600 flex items-center justify-center hover:bg-slate-200 disabled:opacity-50 transition"><i class="ph-bold ph-plus"></i></button>
                                    </div>
                                </div>
                                <div v-if="passengers.kids.length > 0" class="mt-3 pt-3 border-t border-slate-100 space-y-2">
                                    <div v-for="(age, idx) in passengers.kids" :key="idx" class="flex justify-between items-center">
                                        <span class="text-xs font-bold text-slate-500">Child {{ idx + 1 }} Age</span>
                                        <select v-model="passengers.kids[idx]" class="bg-slate-50 border border-slate-200 rounded px-2 py-1 text-xs font-bold text-slate-700 outline-none focus:border-brand-500">
                                            <option v-for="a in 13" :key="a" :value="a + 1">{{ a + 1 }}</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Timezone Footnote -->
                        <div v-if="search.origin" class="absolute top-full mt-1 right-0 text-[10px] text-slate-400 italic">
                            <span class="text-brand-500">*</span> Dates based on {{ search.origin }} local time
                        </div>
                    </div>



                    <!-- FILTERS & ACTIONS ROW -->
                    <div class="mt-8 pt-6 border-t border-slate-100 flex flex-col lg:flex-row items-center justify-between gap-6">
                        
                        <!-- Filters Area -->
                        <div class="flex flex-wrap justify-center lg:justify-start gap-4 items-end w-full lg:w-auto">
                            
                            <!-- One Way Filters -->
                            <div v-if="currentTab === 'oneway'" class="flex flex-wrap gap-4">
                                <!-- Dep Time -->
                                <div class="flex flex-col gap-1 w-40">
                                    <div class="flex justify-between items-center">
                                        <label class="text-[10px] font-bold text-slate-500 uppercase">Dep Time</label>
                                        <span class="text-[10px] font-bold text-brand-600">{{ formatSliderTime(filters.depTime.min) }} - {{ formatSliderTime(filters.depTime.max) }}</span>
                                    </div>
                                    <div class="bg-slate-50 px-3 py-2 rounded-xl border border-slate-200 h-[42px] flex items-center relative">
                                        <div class="range-slider w-full">
                                            <div class="absolute top-1/2 left-0 right-0 h-1 bg-slate-200 rounded -translate-y-1/2"></div>
                                            <div class="absolute top-1/2 h-1 bg-brand-500 rounded -translate-y-1/2" :style="{ left: (filters.depTime.min/24)*100 + '%', right: (100 - (filters.depTime.max/24)*100) + '%' }"></div>
                                            <input type="range" min="0" max="24" step="1" v-model.number="filters.depTime.min" @input="filters.depTime.min = Math.min(filters.depTime.min, filters.depTime.max)">
                                            <input type="range" min="0" max="24" step="1" v-model.number="filters.depTime.max" @input="filters.depTime.max = Math.max(filters.depTime.max, filters.depTime.min)">
                                        </div>
                                    </div>
                                </div>
                                <!-- Arr Time -->
                                <div class="flex flex-col gap-1 w-40">
                                    <div class="flex justify-between items-center">
                                        <label class="text-[10px] font-bold text-slate-500 uppercase">Arr Time</label>
                                        <span class="text-[10px] font-bold text-brand-600">{{ formatSliderTime(filters.arrTime.min) }} - {{ formatSliderTime(filters.arrTime.max) }}</span>
                                    </div>
                                    <div class="bg-slate-50 px-3 py-2 rounded-xl border border-slate-200 h-[42px] flex items-center relative">
                                        <div class="range-slider w-full">
                                            <div class="absolute top-1/2 left-0 right-0 h-1 bg-slate-200 rounded -translate-y-1/2"></div>
                                            <div class="absolute top-1/2 h-1 bg-brand-500 rounded -translate-y-1/2" :style="{ left: (filters.arrTime.min/24)*100 + '%', right: (100 - (filters.arrTime.max/24)*100) + '%' }"></div>
                                            <input type="range" min="0" max="24" step="1" v-model.number="filters.arrTime.min" @input="filters.arrTime.min = Math.min(filters.arrTime.min, filters.arrTime.max)">
                                            <input type="range" min="0" max="24" step="1" v-model.number="filters.arrTime.max" @input="filters.arrTime.max = Math.max(filters.arrTime.max, filters.arrTime.min)">
                                        </div>
                                    </div>
                                </div>
                                <!-- Duration -->
                                <div class="flex flex-col gap-1">
                                    <label class="text-[10px] font-bold text-slate-500 uppercase">Max Duration</label>
                                    <div class="flex items-center gap-2 bg-slate-50 px-3 py-2 rounded-xl border border-slate-200 h-[42px]">
                                        <input type="range" v-model="filters.maxDuration" min="2" max="24" class="w-16 custom-range">
                                        <span class="text-xs font-bold text-slate-700">{{ filters.maxDuration }}h</span>
                                    </div>
                                </div>
                                <!-- Nonstop -->
                                <div class="flex flex-col gap-1">
                                    <label class="text-[10px] font-bold text-transparent uppercase select-none">Nonstop</label> <!-- Spacer Label -->
                                    <button @click="filters.nonStop = !filters.nonStop"
                                        :class="filters.nonStop ? 'bg-purple-100 text-purple-700 border-purple-300' : 'bg-white text-slate-500 border-slate-200 hover:bg-slate-50'" 
                                        class="px-4 py-2 rounded-xl border text-sm font-bold transition flex items-center gap-2 h-[42px]"> <!-- Fixed height to match inputs -->
                                        <i class="ph ph-airplane"></i> Nonstop
                                    </button>
                                </div>
                                <!-- Sort By -->
                                <div class="flex flex-col gap-1" v-click-outside="() => showSortDropdown = false">
                                    <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Sort By</label>
                                    <div @click="showSortDropdown = !showSortDropdown" 
                                         class="bg-slate-50 px-3 py-2 rounded-xl border border-slate-200 h-[42px] flex items-center justify-between cursor-pointer relative hover:border-brand-300 transition-all"
                                         :class="showSortDropdown ? 'border-brand-500 ring-2 ring-brand-500/10' : ''">
                                        <span class="text-xs font-bold text-slate-700 capitalize">{{ oneWay.sortBy }}</span>
                                        <i class="ph ph-caret-down text-slate-400 transition-transform duration-300" :class="showSortDropdown ? 'rotate-180' : ''"></i>
                                        
                                        <!-- Menu -->
                                        <div v-if="showSortDropdown" class="absolute top-full left-0 w-full bg-white border border-slate-100 rounded-xl shadow-xl mt-2 z-50 py-1 animate-fade-in overflow-hidden">
                                            <div v-for="opt in ['price', 'duration', 'stops']" :key="opt" 
                                                 @click.stop="oneWay.sortBy = opt; showSortDropdown = false"
                                                 class="px-3 py-2 hover:bg-brand-50 cursor-pointer flex items-center justify-between group transition-colors">
                                                <span class="text-xs font-bold text-slate-700 capitalize group-hover:text-brand-700">{{ opt }}</span>
                                                <i v-if="oneWay.sortBy === opt" class="ph-bold ph-check text-brand-600 text-xs"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Day Trip Slider -->
                            <div v-if="currentTab === 'daytrip'" class="flex flex-col gap-1">
                                <label class="text-[10px] font-bold text-slate-500 uppercase">Min Hours</label>
                                <div class="flex items-center gap-2 bg-slate-50 px-3 py-2 rounded-xl border border-slate-200 h-[42px]">
                                    <input type="range" v-model="dayTrip.minHours" min="1" max="12" class="w-24 custom-range">
                                    <span class="font-bold text-brand-600 text-sm">{{ dayTrip.minHours }}h</span>
                                </div>
                            </div>

                            <!-- Route Builder Controls -->
                            <div v-if="currentTab === 'builder'" class="flex flex-wrap gap-4">
                                <!-- Min Connect -->
                                <div class="flex flex-col gap-1">
                                    <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wider cursor-help flex items-center gap-1">
                                        Min Connect <i class="ph-fill ph-info text-slate-300"></i>
                                    </label>
                                    <div class="flex items-center gap-2 bg-slate-50 px-3 py-2 rounded-xl border border-slate-200 h-[42px]">
                                        <input type="range" v-model="builder.min" min="0.5" max="5" step="0.5" class="w-20 custom-range">
                                        <span class="text-xs font-bold text-brand-700 w-8">{{ builder.min }}h</span>
                                    </div>
                                </div>
                                <!-- Max Duration -->
                                <div class="flex flex-col gap-1">
                                    <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wider cursor-help flex items-center gap-1">
                                        Max Duration <i class="ph-fill ph-info text-slate-300"></i>
                                    </label>
                                    <div class="flex items-center gap-2 bg-slate-50 px-3 py-2 rounded-xl border border-slate-200 h-[42px]">
                                        <input type="range" v-model="builder.maxDuration" min="4" max="48" class="w-20 custom-range">
                                        <span class="text-xs font-bold text-brand-700 w-8">{{ builder.maxDuration }}h</span>
                                    </div>
                                </div>
                                <!-- Max Stops -->
                                <div class="flex flex-col gap-1">
                                    <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Max Stops</label>
                                    <div class="flex items-center gap-2 bg-slate-50 px-3 py-2 rounded-xl border border-slate-200 h-[42px]">
                                        <input type="range" v-model="builder.maxStops" min="1" max="3" class="w-20 custom-range">
                                        <span class="text-xs font-bold text-brand-700 w-8">{{ builder.maxStops }}</span>
                                    </div>
                                </div>
                                <!-- Sort By -->
                                <div class="flex flex-col gap-1" v-click-outside="() => showSortDropdown = false">
                                    <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Sort By</label>
                                    <div @click="showSortDropdown = !showSortDropdown" 
                                         class="bg-slate-50 px-3 py-2 rounded-xl border border-slate-200 h-[42px] flex items-center justify-between cursor-pointer relative hover:border-brand-300 transition-all"
                                         :class="showSortDropdown ? 'border-brand-500 ring-2 ring-brand-500/10' : ''">
                                        <span class="text-xs font-bold text-slate-700 capitalize">{{ builder.sortBy }}</span>
                                        <i class="ph ph-caret-down text-slate-400 transition-transform duration-300" :class="showSortDropdown ? 'rotate-180' : ''"></i>
                                        
                                        <!-- Menu -->
                                        <div v-if="showSortDropdown" class="absolute top-full left-0 w-full bg-white border border-slate-100 rounded-xl shadow-xl mt-2 z-50 py-1 animate-fade-in overflow-hidden">
                                            <div v-for="opt in ['price', 'duration', 'stops']" :key="opt" 
                                                 @click.stop="builder.sortBy = opt; showSortDropdown = false"
                                                 class="px-3 py-2 hover:bg-brand-50 cursor-pointer flex items-center justify-between group transition-colors">
                                                <span class="text-xs font-bold text-slate-700 capitalize group-hover:text-brand-700">{{ opt }}</span>
                                                <i v-if="builder.sortBy === opt" class="ph-bold ph-check text-brand-600 text-xs"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Weather / Common Filters -->
                            <div v-if="currentTab === 'explore' || (currentTab === 'daytrip' && dayTripMode === 'anywhere')" class="flex flex-wrap gap-2">
                                <button @click="filters.noRain = !filters.noRain" 
                                    :class="filters.noRain ? 'bg-brand-100 text-brand-700 border-brand-300' : 'bg-white text-slate-500 border-slate-200 hover:bg-slate-50'"
                                    class="px-4 py-2 rounded-xl border text-sm font-bold transition flex items-center gap-2 h-[42px] whitespace-nowrap">
                                    <i class="ph ph-cloud-slash"></i> No Rain
                                </button>
                                <button @click="filters.warm = !filters.warm"
                                    :class="filters.warm ? 'bg-orange-100 text-orange-700 border-orange-300' : 'bg-white text-slate-500 border-slate-200 hover:bg-slate-50'" 
                                    class="px-4 py-2 rounded-xl border text-sm font-bold transition flex items-center gap-2 h-[42px] whitespace-nowrap">
                                    <i class="ph ph-sun"></i> Warm (60Â°+)
                                </button>
                                <button @click="filters.nonStop = !filters.nonStop"
                                    :class="filters.nonStop ? 'bg-purple-100 text-purple-700 border-purple-300' : 'bg-white text-slate-500 border-slate-200 hover:bg-slate-50'" 
                                    class="px-4 py-2 rounded-xl border text-sm font-bold transition flex items-center gap-2 h-[42px] whitespace-nowrap">
                                    <i class="ph ph-airplane"></i> Nonstop
                                </button>
                            </div>

                            <!-- Explore View Switcher -->
                            <div v-if="currentTab === 'explore'" class="bg-slate-100 p-1.5 rounded-xl flex gap-1">
                                <button @click="exploreView = 'map'"
                                    :class="exploreView === 'map' ? 'bg-white shadow-md text-brand-700 ring-1 ring-brand-500/20' : 'text-slate-500 hover:text-slate-700 hover:bg-slate-200/50'"
                                    class="px-4 py-2.5 rounded-lg transition flex items-center gap-2 font-bold text-sm">
                                    <i class="ph ph-map-trifold text-xl"></i>
                                    <span>Map</span>
                                </button>
                                <button @click="exploreView = 'list'"
                                    :class="exploreView === 'list' ? 'bg-white shadow-md text-brand-700 ring-1 ring-brand-500/20' : 'text-slate-500 hover:text-slate-700 hover:bg-slate-200/50'"
                                    class="px-4 py-2.5 rounded-lg transition flex items-center gap-2 font-bold text-sm">
                                    <i class="ph ph-list-dashes text-xl"></i>
                                    <span>List</span>
                                </button>
                            </div>
                        </div>

                        <!-- ACTION BUTTON -->
                        <button @click="currentTab === 'explore' ? performExplore() : performSearch()" :disabled="loading" 
                            class="w-full lg:w-auto bg-brand-600 hover:bg-brand-700 text-white font-bold text-lg py-4 px-12 rounded-2xl shadow-xl shadow-brand-600/20 hover:-translate-y-0.5 transition active:scale-95 flex justify-center items-center gap-3 disabled:opacity-70 disabled:cursor-not-allowed">
                            <i v-if="loading" class="ph ph-spinner animate-spin text-2xl"></i>
                            <span v-else>{{ currentTab === 'explore' ? 'Explore Network' : 'Find Flights' }}</span>
                            <i v-if="!loading" class="ph ph-paper-plane-tilt font-bold"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- RESULTS SECTION -->
            <div v-if="hasSearched" class="mt-12 animate-slide-up">
                
                <!-- Error State -->
                <div v-if="error" class="bg-red-50 border border-red-200 rounded-xl p-6 text-center max-w-2xl mx-auto">
                    <div class="text-red-500 text-4xl mb-3"><i class="ph ph-warning-circle"></i></div>
                    <h3 class="text-red-800 font-bold text-lg mb-1">Search Failed</h3>
                    <p class="text-red-600">{{ error }}</p>
                </div>

                <!-- No Results (Day Trip Specific) -->
                <div v-else-if="currentTab === 'daytrip' && searchExecuted && Object.keys(groupedDayTrips).length === 0" class="flex flex-col items-center justify-center py-12 animate-slide-up">
                    
                    <div class="bg-white p-8 rounded-3xl shadow-xl shadow-slate-200/50 border border-slate-100 max-w-md w-full text-center relative overflow-hidden">
                        <!-- Decorative Background Blob -->
                        <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-orange-300 to-red-300"></div>
                        
                        <div class="mb-6 relative inline-block">
                            <div class="absolute inset-0 bg-orange-100 rounded-full blur-lg opacity-50 scale-150"></div>
                            <div class="bg-gradient-to-br from-orange-50 to-white w-20 h-20 rounded-2xl flex items-center justify-center border border-orange-100 shadow-sm relative z-10 rotate-3">
                                <i class="ph ph-airplane-tilt text-4xl text-orange-400/80"></i>
                                <div class="absolute -bottom-2 -right-2 bg-red-100 text-red-500 rounded-full p-1.5 border-2 border-white">
                                    <i class="ph ph-x text-sm font-bold"></i>
                                </div>
                            </div>
                        </div>

                        <h3 class="text-slate-800 font-display font-bold text-2xl mb-2">No Routes Found</h3>
                        <p class="text-slate-500 text-sm mb-8 leading-relaxed">
                            We couldn't find any same-day round trips from <span class="font-bold text-slate-700">{{ search.origin }}</span> that match your current filters.
                        </p>

                        <div class="bg-slate-50 rounded-xl p-4 text-left">
                            <div class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3 flex items-center gap-2">
                                <i class="ph ph-lightbulb"></i> Try adjusting:
                            </div>
                            <ul class="space-y-2.5">
                                <li v-if="filters.nonStop" class="flex items-center gap-3 text-sm text-slate-600 group cursor-pointer hover:text-brand-600 transition" @click="filters.nonStop = false">
                                    <div class="w-5 h-5 rounded-full bg-purple-100 text-purple-600 flex items-center justify-center flex-shrink-0 group-hover:bg-brand-100 group-hover:text-brand-600 transition"><i class="ph ph-check"></i></div>
                                    <span>Turn off <span class="font-bold">Nonstop Only</span></span>
                                </li>
                                <li v-if="filters.noRain" class="flex items-center gap-3 text-sm text-slate-600 group cursor-pointer hover:text-brand-600 transition" @click="filters.noRain = false">
                                    <div class="w-5 h-5 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center flex-shrink-0 group-hover:bg-brand-100 group-hover:text-brand-600 transition"><i class="ph ph-cloud-slash"></i></div>
                                    <span>Allow <span class="font-bold">Rainy</span> destinations</span>
                                </li>
                                <li v-if="filters.warm" class="flex items-center gap-3 text-sm text-slate-600 group cursor-pointer hover:text-brand-600 transition" @click="filters.warm = false">
                                    <div class="w-5 h-5 rounded-full bg-orange-100 text-orange-600 flex items-center justify-center flex-shrink-0 group-hover:bg-brand-100 group-hover:text-brand-600 transition"><i class="ph ph-thermometer"></i></div>
                                    <span>Allow <span class="font-bold">Cooler</span> weather</span>
                                </li>
                                <li class="flex items-center gap-3 text-sm text-slate-600">
                                    <div class="w-5 h-5 rounded-full bg-slate-200 text-slate-500 flex items-center justify-center flex-shrink-0"><i class="ph ph-calendar"></i></div>
                                    <span>Choose a different date</span>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- No Results (Generic - One Way / Builder) -->
                <div v-else-if="results.length === 0 && searchExecuted && currentTab !== 'daytrip' && !(currentTab === 'explore' && exploreView === 'map')" class="text-center py-12">
                    <div class="bg-slate-100 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="ph ph-magnifying-glass text-3xl text-slate-400"></i>
                    </div>
                    <h3 class="text-slate-600 font-bold text-xl">No GoWild fares found for this date.</h3>
                    <p class="text-slate-400">Try adjusting your filters or dates.</p>
                </div>

                <!-- DAY TRIP VIEW -->
                <div v-else-if="currentTab === 'daytrip' && results.length > 0">
                    
                    <!-- Level 1: City Grid -->
                    <div v-if="!selectedDayTripCity" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                        <div v-for="group in sortedDayTrips" :key="group.code" 
                             @click="selectedDayTripCity = group"
                             class="bg-white rounded-2xl border border-slate-100 shadow-sm hover:shadow-xl hover:-translate-y-1 transition duration-300 cursor-pointer flex flex-col group overflow-hidden">
                            <div class="p-6 border-b border-slate-50 bg-slate-50/30 group-hover:bg-brand-50/30 transition flex justify-between items-start">
                                <div>
                                    <div class="flex items-center gap-2 mb-1">
                                        <span class="bg-white border border-slate-200 text-slate-500 text-[10px] font-bold px-2 py-0.5 rounded shadow-sm">{{ group.code }}</span>
                                    </div>
                                    <div class="text-lg font-bold text-slate-800 font-display leading-tight pr-2">{{ group.name }}</div>
                                </div>
                                <div v-if="group.weather" 
                                     :class="group.weather.desc === 'Rainy' ? 'bg-blue-50 text-blue-600 border-blue-100' : 'bg-orange-50 text-orange-600 border-orange-100'"
                                     class="flex flex-col items-center justify-center px-3 py-2 rounded-xl border shadow-sm min-w-[60px]">
                                    <i :class="['ph text-xl mb-0.5', group.weather.icon]"></i>
                                    <div class="text-xs font-bold">{{ group.weather.temp }}Â°</div>
                                </div>
                            </div>
                            <div class="p-4 bg-white flex justify-between items-center mt-auto border-t border-slate-50">
                                <div class="flex items-center gap-2 text-xs font-bold text-brand-600 uppercase tracking-wide">
                                    <span class="w-2 h-2 rounded-full bg-brand-500 animate-pulse"></span>
                                    {{ group.flights.length }} Option{{ group.flights.length > 1 ? 's' : '' }}
                                </div>
                                <div class="w-8 h-8 rounded-full bg-slate-50 group-hover:bg-brand-600 group-hover:text-white flex items-center justify-center transition text-slate-400">
                                    <i class="ph ph-arrow-right"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Level 2: Flight List for City -->
                    <div v-else class="max-w-6xl mx-auto">
                        <div class="mb-8">
                            <button @click="selectedDayTripCity = null" class="group flex items-center gap-2 px-4 py-2 rounded-xl bg-white border border-slate-200 text-slate-600 font-bold text-sm hover:bg-slate-50 hover:border-slate-300 transition mb-6 shadow-sm">
                                <i class="ph ph-arrow-left text-lg group-hover:-translate-x-1 transition"></i>
                                Back to All Cities
                            </button>
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="flex items-center gap-3 mb-1">
                                        <h2 class="text-3xl font-bold text-slate-900">Trips to {{ selectedDayTripCity.name }}</h2>
                                        <span class="bg-brand-100 text-brand-700 font-bold px-2 py-0.5 rounded text-sm border border-brand-200">{{ selectedDayTripCity.code }}</span>
                                    </div>
                                    <div class="text-sm text-slate-500 font-medium">Found {{ selectedDayTripCity.flights.length }} flight options matching your criteria</div>
                                </div>
                                <div v-if="selectedDayTripCity.weather" class="hidden md:flex items-center gap-3 bg-white px-4 py-2 rounded-xl border border-slate-200 shadow-sm">
                                    <div class="text-right">
                                        <div class="text-xs font-bold text-slate-400 uppercase">Forecast</div>
                                        <div class="text-sm font-bold text-slate-700">{{ selectedDayTripCity.weather.desc }}</div>
                                    </div>
                                    <div :class="selectedDayTripCity.weather.desc === 'Rainy' ? 'bg-blue-50 text-blue-600' : 'bg-orange-50 text-orange-600'" class="w-10 h-10 rounded-full flex items-center justify-center text-xl">
                                        <i :class="['ph', selectedDayTripCity.weather.icon]"></i>
                                    </div>
                                    <div class="text-2xl font-bold text-slate-800">{{ selectedDayTripCity.weather.temp }}Â°</div>
                                </div>
                            </div>
                        </div>

                        <div class="space-y-6">
                            <div v-for="(trip, idx) in selectedDayTripCity.flights" :key="idx" class="bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden hover:shadow-md transition duration-300">
                                <!-- Header -->
                                <div class="bg-slate-50/50 px-6 py-4 border-b border-slate-100 flex justify-between items-center">
                                    <div class="flex items-center gap-3">
                                        <div class="bg-brand-600 text-white px-3 py-1 rounded-lg text-xs font-bold shadow-sm shadow-brand-500/30">Option {{ idx + 1 }}</div>
                                        <div class="w-px h-4 bg-slate-300 mx-1"></div>
                                        <div class="bg-orange-100 text-orange-700 px-3 py-1 rounded-lg text-sm font-bold border border-orange-200 shadow-sm flex items-center gap-1.5">
                                            <i class="ph ph-hourglass text-lg"></i> {{ trip.hours_at_dest }} Hours in City
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-2xl font-bold text-slate-900 tracking-tight">${{ trip.total_price }}</div>
                                        <a href="javascript:void(0)" @click.stop="bookFlight(trip, true)" class="inline-block mt-1 px-4 py-1.5 bg-brand-600 hover:bg-brand-700 text-white text-xs font-bold rounded-lg transition shadow-sm">Book Trip</a>
                                    </div>
                                </div>

                                <!-- Flights (Redesigned Flow Layout) -->
                                <div class="p-6">
                                    <div class="flex flex-col lg:flex-row gap-6 items-stretch relative">
                                        
                                        <!-- Connecting Line (Desktop) -->
                                        <div class="hidden lg:block absolute top-1/2 left-0 right-0 h-px bg-slate-200 -translate-y-1/2 z-0"></div>

                                        <!-- Outbound Leg -->
                                        <div class="flex-1 bg-slate-50 rounded-xl p-4 border border-slate-200 relative z-10 hover:border-brand-300 transition">
                                            <div class="flex justify-between items-start mb-3">
                                                <div class="text-xs font-bold text-slate-500 uppercase tracking-wider flex items-center gap-2">
                                                    <span class="w-2 h-2 rounded-full bg-brand-500"></span> Outbound
                                                </div>
                                                <div class="text-xs font-bold text-slate-700 bg-white px-2 py-1 rounded border border-slate-200 shadow-sm">${{ trip.outbound.price }}</div>
                                            </div>
                                            <div class="flex justify-between items-center mb-1">
                                                <div class="font-bold text-slate-800 text-sm">{{ trip.outbound.origin }} <i class="ph ph-arrow-right text-[10px] text-slate-400 mx-1"></i> {{ trip.outbound.destination }}</div>
                                                <div class="font-mono text-xs text-slate-500">{{ trip.outbound.duration }}</div>
                                            </div>
                                            <div class="flex justify-between items-center text-xs text-slate-500">
                                                <span class="font-mono">{{ formatTime(trip.outbound.departure) }} - {{ formatTime(trip.outbound.arrival) }}</span>
                                                <span class="font-mono">{{ trip.outbound.flightNumber }}</span>
                                            </div>
                                            <div class="mt-2 pt-2 border-t border-slate-200/50 flex justify-between items-center">
                                                <span v-if="trip.outbound.stops === 0" class="text-brand-600 font-bold text-[10px]">Nonstop</span>
                                                <span v-else class="text-orange-600 font-bold text-[10px]">{{ trip.outbound.stops }} Stop(s)</span>
                                                <a href="javascript:void(0)" @click.stop="bookFlight(trip.outbound)" class="text-xs font-bold text-brand-600 hover:text-brand-800 underline">Book</a>
                                            </div>
                                        </div>

                                        <!-- Destination Node -->
                                        <div class="lg:w-auto flex flex-col items-center justify-center relative z-10">
                                            <div class="bg-white border-2 border-brand-100 rounded-xl p-3 shadow-sm text-center min-w-[140px] hover:border-brand-300 transition cursor-help" title="Time available at destination">
                                                <div class="text-brand-500 text-xl mb-1"><i class="ph ph-clock-countdown"></i></div>
                                                <div class="text-[10px] font-bold text-brand-800 uppercase tracking-tight">Time in City</div>
                                                <div class="text-xs font-bold text-slate-800 my-0.5">{{ trip.outbound.destination }}</div>
                                                <div class="text-lg font-bold text-brand-600">{{ trip.hours_at_dest }}h</div>
                                            </div>
                                        </div>

                                        <!-- Return Leg -->
                                        <div class="flex-1 bg-slate-50 rounded-xl p-4 border border-slate-200 relative z-10 hover:border-brand-300 transition">
                                            <div class="flex justify-between items-start mb-3">
                                                <div class="text-xs font-bold text-slate-500 uppercase tracking-wider flex items-center gap-2">
                                                    <span class="w-2 h-2 rounded-full bg-orange-500"></span> Return
                                                </div>
                                                <div class="text-xs font-bold text-slate-700 bg-white px-2 py-1 rounded border border-slate-200 shadow-sm">${{ trip.return.price }}</div>
                                            </div>
                                            <div class="flex justify-between items-center mb-1">
                                                <div class="font-bold text-slate-800 text-sm">{{ trip.return.origin }} <i class="ph ph-arrow-right text-[10px] text-slate-400 mx-1"></i> {{ trip.return.destination }}</div>
                                                <div class="font-mono text-xs text-slate-500">{{ trip.return.duration }}</div>
                                            </div>
                                            <div class="flex justify-between items-center text-xs text-slate-500">
                                                <span class="font-mono">{{ formatTime(trip.return.departure) }} - {{ formatTime(trip.return.arrival) }}</span>
                                                <span class="font-mono">{{ trip.return.flightNumber }}</span>
                                            </div>
                                            <div class="mt-2 pt-2 border-t border-slate-200/50 flex justify-between items-center">
                                                <span v-if="trip.return.stops === 0" class="text-brand-600 font-bold text-[10px]">Nonstop</span>
                                                <span v-else class="text-orange-600 font-bold text-[10px]">{{ trip.return.stops }} Stop(s)</span>
                                                <a href="javascript:void(0)" @click.stop="bookFlight(trip.return)" class="text-xs font-bold text-brand-600 hover:text-brand-800 underline">Book</a>
                                            </div>
                                        </div>

                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- MAP VIEW (Explore) -->
                <div v-else-if="currentTab === 'explore' && exploreView === 'map'" id="explore-map-view" class="h-[700px] w-full relative">
                    <div id="map" class="w-full h-full absolute left-0 top-0" style="z-index: 1;"></div>

                    <!-- No Flights Available Overlay -->
                    <div v-if="searchExecuted && !loading && filteredMapCount === 0" class="absolute inset-0 bg-slate-50/95 backdrop-blur-sm flex items-center justify-center" style="z-index: 200;">
                        <div class="bg-white p-8 rounded-3xl shadow-xl shadow-slate-200/50 border border-slate-100 max-w-md w-full text-center relative overflow-hidden animate-slide-up">
                            <!-- Decorative Background Blob -->
                            <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-brand-300 to-blue-300"></div>

                            <div class="mb-6 relative inline-block">
                                <div class="absolute inset-0 bg-brand-100 rounded-full blur-lg opacity-50 scale-150"></div>
                                <div class="bg-gradient-to-br from-brand-50 to-white w-20 h-20 rounded-2xl flex items-center justify-center border border-brand-100 shadow-sm relative z-10 rotate-3">
                                    <i class="ph ph-map-trifold text-4xl text-brand-400/80"></i>
                                    <div class="absolute -bottom-2 -right-2 bg-slate-100 text-slate-500 rounded-full p-1.5 border-2 border-white">
                                        <i class="ph ph-x text-sm font-bold"></i>
                                    </div>
                                </div>
                            </div>

                            <h3 class="text-slate-800 font-display font-bold text-2xl mb-2">No Flights Available</h3>
                            <p class="text-slate-500 text-sm mb-8 leading-relaxed">
                                We couldn't find any flights {{ exploreMode === 'origin' ? 'from' : 'to' }} <span class="font-bold text-slate-700">{{ exploreMode === 'origin' ? search.origin : search.destination }}</span> on <span class="font-bold text-slate-700">{{ search.date }}</span>.
                            </p>

                            <div class="bg-slate-50 rounded-xl p-4 text-left">
                                <div class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3 flex items-center gap-2">
                                    <i class="ph ph-lightbulb"></i> Try These Instead
                                </div>
                                <ul class="text-sm text-slate-600 space-y-2">
                                    <li class="flex items-start gap-2">
                                        <i class="ph ph-check-circle text-brand-500 mt-0.5"></i>
                                        <span>Select a different date with available GoWild fares</span>
                                    </li>
                                    <li class="flex items-start gap-2">
                                        <i class="ph ph-check-circle text-brand-500 mt-0.5"></i>
                                        <span>Switch between origin/destination mode using the toggle above</span>
                                    </li>
                                    <li class="flex items-start gap-2">
                                        <i class="ph ph-check-circle text-brand-500 mt-0.5"></i>
                                        <span>Try a different airport to explore more options</span>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- Side Panel -->
                    <div v-if="selectedDest" class="absolute right-0 top-0 w-full lg:w-1/3 h-full bg-white/95 backdrop-blur-xl border-l border-slate-200 shadow-2xl animate-fade-in flex flex-col" style="z-index: 100;">
                        <div class="p-6 border-b border-slate-100 bg-slate-50/50 flex justify-between items-start">
                            <div>
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="bg-brand-100 text-brand-700 text-xs font-bold px-2 py-0.5 rounded">{{ selectedDest.code }}</span>
                                    <span class="text-slate-400 text-xs font-bold uppercase">{{ search.date }}</span>
                                    <span v-if="getWeather(selectedDest.code)" class="text-2xl">{{ getWeather(selectedDest.code).emoji }}</span>
                                </div>
                                <h2 class="text-3xl font-bold text-slate-900 font-display">{{ selectedDest.city }}</h2>
                                <div v-if="getWeather(selectedDest.code)" class="mt-1 text-sm text-slate-500">
                                    {{ getWeather(selectedDest.code).temp }}Â° â¢ {{ getWeather(selectedDest.code).desc }}
                                </div>
                            </div>
                            <button @click="selectedDest = null" class="w-8 h-8 rounded-full bg-white border border-slate-200 hover:bg-slate-100 flex items-center justify-center text-slate-500"><i class="ph ph-x"></i></button>
                        </div>
                        
                        <div class="flex-1 overflow-y-auto p-4 space-y-3">
                            <div v-for="(flight, i) in destFlights" :key="i" class="bg-white border border-slate-100 rounded-xl overflow-hidden shadow-sm hover:shadow-md hover:border-brand-200 transition">
                                <!-- Flight Header -->
                                <div class="p-4 border-b border-slate-50 bg-slate-50/30 flex justify-between items-center">
                                    <div class="flex items-center gap-2">
                                        <div class="w-8 h-8 rounded-full bg-white border border-slate-100 flex items-center justify-center text-brand-600 shadow-sm">
                                            <i class="ph ph-airplane-tilt"></i>
                                        </div>
                                        <div>
                                            <div class="font-bold text-slate-800">{{ flight.origin }} â {{ flight.destination }}</div>
                                            <div class="text-xs text-slate-400 font-medium">{{ search.date }}</div>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-2xl font-bold text-slate-900">${{ flight.price }}</div>
                                    </div>
                                </div>

                                <!-- Flight Details -->
                                <div class="p-4">
                                    <div class="flex justify-between items-center mb-4">
                                        <div class="text-center">
                                            <div class="text-lg font-bold text-slate-800">{{ formatTime(flight.departure) }}</div>
                                            <div class="text-xs text-slate-400 font-bold">{{ flight.origin }}</div>
                                        </div>
                                        <div class="flex-1 px-4 flex flex-col items-center justify-between py-2">
                                            <div class="text-xs text-slate-400 flex flex-col items-center">
                                                <span>{{ formatDurationMain(flight.duration) }}</span>
                                                <span v-if="formatDurationSub(flight.duration)" class="text-orange-500 font-bold text-[10px]">{{ formatDurationSub(flight.duration) }}</span>
                                            </div>
                                            <div class="w-full h-px bg-slate-200 relative flex-shrink-0">
                                                <i class="ph ph-airplane text-slate-300 absolute top-1/2 right-0 -translate-y-1/2 rotate-90 text-xs bg-white pl-1 pr-0.5"></i>
                                            </div>
                                            <div class="text-[10px] text-brand-600 font-bold uppercase text-center leading-tight">
                                                <span v-if="flight.stops === 0">Nonstop</span>
                                                <span v-else>
                                                    {{ flight.stops }} Stop{{ flight.stops > 1 ? 's' : '' }}
                                                    <span v-if="flight.layover_airports && flight.layover_airports.length" class="block text-[9px] text-slate-400 normal-case">
                                                        via {{ flight.layover_airports.join(', ') }}
                                                    </span>
                                                </span>
                                            </div>
                                        </div>
                                        <div class="text-center">
                                            <div class="text-lg font-bold text-slate-800">{{ formatTime(flight.arrival) }}</div>
                                            <div class="text-xs text-slate-400 font-bold">{{ flight.destination }}</div>
                                        </div>
                                    </div>

                                    <a href="javascript:void(0)" @click="bookFlight(flight)" class="block w-full bg-brand-600 hover:bg-brand-700 text-white text-center font-bold py-3 rounded-xl shadow-lg shadow-brand-600/20 transition transform active:scale-95">
                                        Book on Frontier
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- EXPLORE LIST VIEW -->
                <div v-else-if="currentTab === 'explore' && exploreView === 'list'">
                    <div class="flex flex-col gap-6">
                        <div v-for="(row, rIdx) in chunkedExploreDestinations" :key="rIdx" class="contents-wrapper">
                            
                            <!-- Grid Row -->
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                                <div v-for="group in row" :key="group.code"
                                     @click="selectedExploreCode = selectedExploreCode === group.code ? null : group.code"
                                     class="bg-white rounded-2xl border border-slate-100 shadow-sm transition-all duration-300 flex flex-col overflow-hidden group cursor-pointer hover:shadow-xl hover:-translate-y-1"
                                     :class="selectedExploreCode === group.code ? 'ring-2 ring-brand-500 shadow-lg' : ''">

                                    <!-- Destination Card Header -->
                                    <div class="p-6 border-b border-slate-50 bg-slate-50/30 group-hover:bg-brand-50/30 transition flex justify-between items-start">
                                        <div>
                                            <div class="flex items-center gap-2 mb-1">
                                                <span class="bg-white border border-slate-200 text-slate-500 text-[10px] font-bold px-2 py-0.5 rounded shadow-sm">{{ group.code }}</span>
                                                <i :class="selectedExploreCode === group.code ? 'ph-caret-up text-brand-600' : 'ph-caret-down text-slate-400'" class="ph text-sm transition-colors"></i>
                                            </div>
                                            <div class="text-lg font-bold text-slate-800 font-display leading-tight pr-2">{{ group.name }}</div>
                                        </div>
                                        <div v-if="group.weather"
                                             :class="group.weather.desc === 'Rainy' ? 'bg-blue-50 text-blue-600 border-blue-100' : 'bg-orange-50 text-orange-600 border-orange-100'"
                                             class="flex flex-col items-center justify-center px-3 py-2 rounded-xl border shadow-sm min-w-[60px]">
                                            <i :class="['ph text-xl mb-0.5', group.weather.icon]"></i>
                                            <div class="text-xs font-bold">{{ group.weather.temp }}Â°</div>
                                        </div>
                                    </div>

                                    <!-- Card Footer -->
                                    <div class="p-4 bg-white flex justify-between items-center mt-auto border-t border-slate-50">
                                        <div class="flex items-center gap-2 text-xs font-bold text-brand-600 uppercase tracking-wide">
                                            <span class="w-2 h-2 rounded-full bg-brand-500 animate-pulse"></span>
                                            {{ group.flights.length }} Flight{{ group.flights.length > 1 ? 's' : '' }}
                                        </div>
                                        <div class="text-right">
                                            <div class="text-xs text-slate-400 font-bold">FROM</div>
                                            <div class="text-lg font-bold text-slate-900">${{ group.minPrice }}</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Details Panel (Full Width Row) -->
                            <div v-if="rowHasSelected(row)" class="w-full bg-slate-50/50 border border-slate-100 rounded-2xl p-6 animate-slide-up mt-2 mb-2 relative">
                                <!-- Decorative Arrow (Optional, tricky to position dynamically without ref, skipping for robustness) -->
                                
                                <div class="mb-6 flex flex-col md:flex-row justify-between md:items-center gap-4">
                                    <div>
                                        <div class="flex items-center gap-3 mb-1">
                                            <h3 class="text-slate-900 font-bold text-xl">Flights to {{ getSelectedGroupInRow(row).name }}</h3>
                                            <span class="bg-brand-100 text-brand-700 text-xs font-bold px-2 py-0.5 rounded">{{ getSelectedGroupInRow(row).code }}</span>
                                        </div>
                                        <p class="text-slate-500 text-sm">Found {{ getSelectedGroupInRow(row).flights.length }} option{{ getSelectedGroupInRow(row).flights.length > 1 ? 's' : '' }} starting at ${{ getSelectedGroupInRow(row).minPrice }}</p>
                                    </div>
                                    <div class="flex gap-2">
                                         <button @click="selectedExploreCode = null" class="px-4 py-2 rounded-lg border border-slate-200 bg-white text-slate-600 font-bold text-sm hover:bg-slate-50 transition shadow-sm">Close</button>
                                    </div>
                                </div>

                                <div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-4">
                                    <div v-for="(flight, idx) in getSelectedGroupInRow(row).flights" :key="idx" class="bg-white border border-slate-200 rounded-xl overflow-hidden shadow-sm hover:shadow-md hover:border-brand-300 transition group/card">
                                        <!-- Flight Header -->
                                        <div class="p-4 border-b border-slate-100 flex justify-between items-center bg-white">
                                            <div class="flex items-center gap-2">
                                                <div class="bg-brand-100 text-brand-600 px-2 py-1 rounded text-xs font-bold">Option {{ idx + 1 }}</div>
                                                <span class="text-xs text-slate-400 font-mono">{{ search.date }}</span>
                                            </div>
                                            <div class="text-xl font-bold text-slate-900">${{ flight.price }}</div>
                                        </div>

                                        <!-- Flight Body -->
                                        <div class="p-4">
                                            <div class="flex justify-between items-center mb-4">
                                                <div class="text-center">
                                                    <div class="text-lg font-bold text-slate-800">{{ formatTime(flight.departure) }}</div>
                                                    <div class="text-[10px] text-slate-500 font-bold uppercase">{{ flight.origin }}</div>
                                                </div>
                                                
                                                <!-- Center Info -->
                                                <div class="flex flex-col items-center px-3 flex-1">
                                                    <!-- Duration -->
                                                    <div class="text-[10px] text-slate-400 font-bold mb-1 flex items-center gap-1">
                                                        <i class="ph ph-clock"></i> {{ flight.duration }}
                                                    </div>
                                                    
                                                    <!-- Line -->
                                                    <div class="w-full h-px bg-slate-200 relative my-3">
                                                        <i class="ph ph-airplane text-brand-500 absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 rotate-90 text-xs bg-white px-1"></i>
                                                    </div>
                                                    
                                                    <!-- Stops -->
                                                    <div class="text-[10px] font-bold text-center leading-tight">
                                                        <span v-if="flight.stops === 0" class="text-brand-600">Nonstop</span>
                                                        <span v-else class="text-orange-600">
                                                            {{ flight.stops }} Stop
                                                            <span class="block font-normal text-slate-400 text-[9px] mt-0.5">{{ getLayoverSummary(flight) }}</span>
                                                        </span>
                                                    </div>
                                                </div>

                                                <div class="text-center">
                                                    <div class="text-lg font-bold text-slate-800">{{ formatTime(flight.arrival) }}</div>
                                                    <div class="text-[10px] text-slate-500 font-bold uppercase">{{ flight.destination }}</div>
                                                </div>
                                            </div>

                                            <a href="javascript:void(0)" @click.stop="bookFlight(flight)" class="block w-full py-2.5 rounded-lg bg-brand-600 hover:bg-brand-700 text-white font-bold text-center text-sm transition shadow-lg shadow-brand-600/20 transform active:scale-95">
                                                Book Flight
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>

                <!-- GRID VIEW (Common - One Way / Builder) -->
                <div v-else-if="currentTab !== 'explore'" 
                     class="flex flex-col gap-4 w-full max-w-6xl mx-auto">
                    
                    <!-- Flight Card -->
                    <div v-for="(item, i) in (currentTab === 'builder' ? sortedBuilderResults : (currentTab === 'oneway' ? sortedOneWayResults : results))" :key="i" 
                        @click="selectedFlight = item"
                        class="w-full bg-white rounded-2xl border border-slate-100 shadow-sm hover:shadow-xl hover:-translate-y-1 transition duration-300 overflow-hidden flex flex-col cursor-pointer group">
                        
                        <!-- Card Header Removed -->

                        <!-- Card Body (Unified List View) -->
                        <div class="flex-1">
                            
                            <!-- 1. ROUTE BUILDER -->
                            <div v-if="currentTab === 'builder'">
                                <!-- MULTI-HOP LAYOUT (2 segments) -->
                                <div v-if="item.segments.length > 1">
                                    <!-- Header -->
                                    <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-start bg-slate-50/50">
                                        <div>
                                            <div class="flex items-center gap-2 text-slate-800 font-bold text-lg">
                                                <span>{{ item.segments[0].origin }}</span>
                                                <i class="ph ph-arrow-right text-slate-300 text-sm"></i>
                                                <span class="px-2 py-0.5 rounded bg-orange-50 text-orange-700 border border-orange-100 text-sm font-bold">{{ item.via }}</span>
                                                <i class="ph ph-arrow-right text-slate-300 text-sm"></i>
                                                <span>{{ item.segments[1].destination }}</span>
                                            </div>
                                            <div class="flex items-center gap-4 text-xs text-slate-400 mt-1 font-medium">
                                                <span class="flex items-center gap-1"><i class="ph ph-clock"></i> {{ formatDecimalHours(item.total_duration_hours) }}</span>
                                                <span class="flex items-center gap-1"><i class="ph ph-steps"></i> {{ item.total_stops }} Stops</span>
                                            </div>
                                        </div>
                                        <div class="text-right">
                                            <div class="text-2xl font-bold text-slate-900 tracking-tight">${{ Number(item.total_price).toFixed(2) }}</div>
                                            <a href="javascript:void(0)" @click.stop="openBookingModal(item)" class="inline-block mt-2 px-4 py-1.5 bg-slate-800 hover:bg-slate-900 text-white text-xs font-bold rounded-lg transition">Book</a>
                                        </div>
                                    </div>

                                    <!-- Horizontal Layout (Restored Structure + New Style) -->
                                    <div class="p-6">
                                        <div class="flex flex-col lg:flex-row gap-6 items-stretch relative">
                                            <!-- Connecting Line (Desktop) -->
                                            <div class="hidden lg:block absolute top-1/2 left-0 right-0 h-px bg-slate-200 -translate-y-1/2 z-0"></div>

                                            <!-- Leg 1 -->
                                            <div class="flex-1 bg-white rounded-xl p-4 border border-slate-200 relative z-10 shadow-sm hover:border-brand-300 transition group/leg">
                                                <div class="flex justify-between items-start mb-3">
                                                    <div class="text-[10px] font-bold text-slate-400 uppercase tracking-wider flex items-center gap-2">
                                                        <span class="w-2 h-2 rounded-full bg-brand-500"></span> Leg 1
                                                    </div>
                                                    <div class="text-xs font-bold text-slate-700 bg-slate-50 px-2 py-1 rounded border border-slate-100 shadow-sm">${{ item.segments[0].price }}</div>
                                                </div>
                                                
                                                <!-- Standard Flight Info (Mini) -->
                                                <div class="flex items-center gap-3 mb-3">
                                                    <div class="text-center min-w-[60px]">
                                                        <div class="text-lg font-bold text-slate-800">{{ formatTime(item.segments[0].departure) }}</div>
                                                        <div class="text-[10px] font-bold text-slate-400">{{ item.segments[0].origin }}</div>
                                                    </div>
                                                    
                                                    <div class="flex-1 flex flex-col items-center px-1">
                                                        <div class="text-[9px] font-bold text-slate-400 mb-0.5">{{ item.segments[0].duration }}</div>
                                                        <div class="w-full h-px bg-slate-200 relative flex items-center justify-between">
                                                            <div class="w-1 h-1 rounded-full bg-slate-300"></div>
                                                            <!-- Dots -->
                                                            <div v-if="item.segments[0].stops > 0" class="flex gap-0.5 bg-white px-0.5 relative z-10">
                                                                <div v-for="n in item.segments[0].stops" :key="n" class="w-1 h-1 rounded-full bg-orange-400"></div>
                                                            </div>
                                                            <div class="w-1 h-1 rounded-full bg-slate-300"></div>
                                                        </div>
                                                    </div>

                                                    <div class="text-center min-w-[60px]">
                                                        <div class="text-lg font-bold text-slate-800">{{ formatTime(item.segments[0].arrival) }}</div>
                                                        <div class="text-[10px] font-bold text-slate-400">{{ item.segments[0].destination }}</div>
                                                    </div>
                                                </div>
                                                
                                                <div class="flex justify-center items-center pt-2 border-t border-slate-50">
                                                    <span v-if="item.segments[0].stops === 0" class="text-[10px] font-bold text-brand-600 uppercase">Nonstop</span>
                                                    <span v-else class="text-[10px] font-bold text-orange-600 uppercase">{{ item.segments[0].stops }} Stop</span>
                                                </div>
                                            </div>

                                            <!-- Connection Node -->
                                            <div class="lg:w-auto flex flex-col items-center justify-center relative z-10">
                                                <div class="bg-white border-2 border-orange-100 rounded-xl p-2 shadow-sm text-center min-w-[100px]">
                                                    <div class="text-[10px] font-bold text-orange-800 uppercase">{{ item.via }}</div>
                                                    <div class="text-xs font-bold text-orange-600">{{ item.layover_hours }}h</div>
                                                </div>
                                            </div>

                                            <!-- Leg 2 -->
                                            <div class="flex-1 bg-white rounded-xl p-4 border border-slate-200 relative z-10 shadow-sm hover:border-brand-300 transition group/leg">
                                                <div class="flex justify-between items-start mb-3">
                                                    <div class="text-[10px] font-bold text-slate-400 uppercase tracking-wider flex items-center gap-2">
                                                        <span class="w-2 h-2 rounded-full bg-orange-500"></span> Leg 2
                                                    </div>
                                                    <div class="text-xs font-bold text-slate-700 bg-slate-50 px-2 py-1 rounded border border-slate-100 shadow-sm">${{ item.segments[1].price }}</div>
                                                </div>

                                                <!-- Standard Flight Info (Mini) -->
                                                <div class="flex items-center gap-3 mb-3">
                                                    <div class="text-center min-w-[60px]">
                                                        <div class="text-lg font-bold text-slate-800">{{ formatTime(item.segments[1].departure) }}</div>
                                                        <div class="text-[10px] font-bold text-slate-400">{{ item.segments[1].origin }}</div>
                                                    </div>
                                                    
                                                    <div class="flex-1 flex flex-col items-center px-1">
                                                        <div class="text-[9px] font-bold text-slate-400 mb-0.5">{{ item.segments[1].duration }}</div>
                                                        <div class="w-full h-px bg-slate-200 relative flex items-center justify-between">
                                                            <div class="w-1 h-1 rounded-full bg-slate-300"></div>
                                                            <!-- Dots -->
                                                            <div v-if="item.segments[1].stops > 0" class="flex gap-0.5 bg-white px-0.5 relative z-10">
                                                                <div v-for="n in item.segments[1].stops" :key="n" class="w-1 h-1 rounded-full bg-orange-400"></div>
                                                            </div>
                                                            <div class="w-1 h-1 rounded-full bg-slate-300"></div>
                                                        </div>
                                                    </div>

                                                    <div class="text-center min-w-[60px]">
                                                        <div class="text-lg font-bold text-slate-800">{{ formatTime(item.segments[1].arrival) }}</div>
                                                        <div class="text-[10px] font-bold text-slate-400">{{ item.segments[1].destination }}</div>
                                                    </div>
                                                </div>

                                                <div class="flex justify-center items-center pt-2 border-t border-slate-50">
                                                    <span v-if="item.segments[1].stops === 0" class="text-[10px] font-bold text-brand-600 uppercase">Nonstop</span>
                                                    <span v-else class="text-[10px] font-bold text-orange-600 uppercase">{{ item.segments[1].stops }} Stop</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Direct Flight (Builder Fallback - New Standard Layout) -->
                                <div v-else class="p-0">
                                    <div class="flex flex-col md:flex-row items-stretch">
                                        
                                        <!-- Left: Flight Info -->
                                        <div class="flex-1 p-5 flex items-center gap-6">
                                            <!-- Airline Logo -->
                                            <div class="hidden sm:flex flex-col items-center justify-center w-12">
                                                <img src="/static/logo_wild.svg" alt="Frontier" class="w-8 h-8 opacity-80" onerror="this.style.display='none'">
                                            </div>

                                            <!-- Times & Route -->
                                            <div class="flex-1 flex items-center justify-between gap-8">
                                                <!-- Departure -->
                                                <div class="text-center min-w-[80px]">
                                                    <div class="text-xl font-bold text-slate-800">{{ formatTime(item.segments[0].departure) }}</div>
                                                    <div class="text-xs font-bold text-slate-500">{{ item.segments[0].origin }}</div>
                                                </div>

                                                <!-- Duration / Stops Graphic -->
                                                <div class="flex-1 flex flex-col items-center px-2">
                                                    <div class="text-[10px] font-bold text-slate-400 mb-1 flex items-center gap-1">
                                                        {{ item.segments[0].duration }}
                                                    </div>
                                                    <div class="w-full h-px bg-slate-300 relative flex items-center justify-between">
                                                        <div class="w-1.5 h-1.5 rounded-full bg-slate-400"></div>
                                                        <!-- Stops Dots -->
                                                        <div v-if="item.segments[0].stops > 0" class="flex gap-1 bg-white px-1 relative z-10">
                                                            <div v-for="n in item.segments[0].stops" :key="n" class="w-1 h-1 rounded-full bg-orange-400 border border-white ring-1 ring-orange-100"></div>
                                                        </div>
                                                        <div class="w-1.5 h-1.5 rounded-full bg-slate-400"></div>
                                                    </div>
                                                    <div class="text-[10px] font-bold uppercase mt-1 text-center">
                                                        <span v-if="item.segments[0].stops === 0" class="text-brand-600">Nonstop</span>
                                                        <span v-else class="text-orange-600">
                                                            {{ item.segments[0].stops }} Stop{{ item.segments[0].stops > 1 ? 's' : '' }}
                                                            <span v-if="item.segments[0].layover_airports" class="normal-case text-slate-400 block text-[9px] truncate max-w-[100px]" :title="item.segments[0].layover_airports.join(', ')">{{ item.segments[0].layover_airports.join(', ') }}</span>
                                                        </span>
                                                    </div>
                                                </div>

                                                <!-- Arrival -->
                                                <div class="text-center min-w-[80px]">
                                                    <div class="text-xl font-bold text-slate-800">{{ formatTime(item.segments[0].arrival) }}</div>
                                                    <div class="text-xs font-bold text-slate-500">{{ item.segments[0].destination }}</div>
                                                    <div v-if="getDateDiffLabel(item.segments[0].departure, item.segments[0].arrival)" class="text-[10px] text-red-500 font-bold mt-0.5">
                                                        {{ getDateDiffLabel(item.segments[0].departure, item.segments[0].arrival) }}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Right: Price & Action -->
                                        <div class="border-t md:border-t-0 md:border-l border-slate-100 bg-slate-50/50 p-5 flex flex-row md:flex-col items-center justify-between md:justify-center gap-4 md:w-48">
                                            <div class="text-right md:text-center">
                                                <div class="text-xs font-bold text-slate-400 uppercase mb-0.5">Total</div>
                                                <div class="text-2xl font-bold text-slate-900 tracking-tight">${{ Number(item.total_price).toFixed(0) }}</div>
                                            </div>
                                            <a href="javascript:void(0)" @click.stop="bookFlight(item.segments[0], false)" class="w-auto md:w-full px-6 py-2.5 rounded-xl bg-brand-600 hover:bg-brand-700 text-white font-bold text-center text-sm transition shadow-lg shadow-brand-600/20 active:scale-95 whitespace-nowrap flex items-center justify-center gap-2">
                                                Select <i class="ph-bold ph-caret-right"></i>
                                            </a>
                                        </div>

                                    </div>
                                </div>
                            </div>

                            <!-- 2. ONE WAY (New Standard Layout) -->
                            <div v-else-if="currentTab === 'oneway'" class="p-0">
                                <div class="flex flex-row items-stretch">
                                    
                                    <!-- F9 Logo -->
                                    <div class="hidden sm:flex flex-col items-center justify-center w-12">
                                        <img src="/static/logo_wild.svg" alt="Frontier" class="w-8 h-8 opacity-80" onerror="this.style.display='none'">
                                    </div>

                                    <!-- Times & Route -->
                                    <div class="flex-1 flex items-center justify-between gap-8 p-5">
                                        <!-- Departure -->
                                        <div class="text-center min-w-[80px]">
                                            <div class="text-xl font-bold text-slate-800">{{ formatTime(item.departure) }}</div>
                                            <div class="text-xs font-bold text-slate-500">{{ item.origin }}</div>
                                        </div>

                                        <!-- Duration / Stops Graphic -->
                                        <div class="flex-1 flex flex-col items-center px-2">
                                            <div class="text-[10px] font-bold text-slate-400 mb-1 flex items-center gap-1">
                                                {{ item.duration }}
                                            </div>
                                            <div class="w-full h-px bg-slate-300 relative flex items-center justify-between">
                                                <div class="w-1.5 h-1.5 rounded-full bg-slate-400"></div>
                                                <!-- Stops Dots -->
                                                <div v-if="item.stops > 0" class="flex gap-1 bg-white px-1 relative z-10">
                                                    <div v-for="n in item.stops" :key="n" class="w-1 h-1 rounded-full bg-orange-400 border border-white ring-1 ring-orange-100"></div>
                                                </div>
                                                <div class="w-1.5 h-1.5 rounded-full bg-slate-400"></div>
                                            </div>
                                            <div class="text-[10px] font-bold uppercase mt-1 text-center">
                                                <span v-if="item.stops === 0" class="text-brand-600">Nonstop</span>
                                                <span v-else class="text-orange-600">
                                                    {{ item.stops }} Stop{{ item.stops > 1 ? 's' : '' }}
                                                    <span v-if="item.layover_airports" class="normal-case text-slate-400 block text-[9px] truncate max-w-[100px]" :title="item.layover_airports.join(', ')">{{ item.layover_airports.join(', ') }}</span>
                                                </span>
                                            </div>
                                        </div>

                                        <!-- Arrival -->
                                        <div class="text-center min-w-[80px]">
                                            <div class="text-xl font-bold text-slate-800">{{ formatTime(item.arrival) }}</div>
                                            <div class="text-xs font-bold text-slate-500">{{ item.destination }}</div>
                                            <div v-if="getDateDiffLabel(item.departure, item.arrival)" class="text-[10px] text-red-500 font-bold mt-0.5">
                                                {{ getDateDiffLabel(item.departure, item.arrival) }}
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Right: Price & Action -->
                                    <div class="border-l border-slate-100 bg-slate-50/50 p-5 flex flex-col items-center justify-center gap-4 w-48">
                                        <div class="text-center">
                                            <div class="text-xs font-bold text-slate-400 uppercase mb-0.5">Total</div>
                                            <div class="text-2xl font-bold text-slate-900 tracking-tight">${{ Number(item.price).toFixed(0) }}</div>
                                        </div>
                                        <a href="javascript:void(0)" @click.stop="bookFlight(item)" class="w-full px-6 py-2.5 rounded-xl bg-brand-600 hover:bg-brand-700 text-white font-bold text-center text-sm transition shadow-lg shadow-brand-600/20 active:scale-95 whitespace-nowrap flex items-center justify-center gap-2">
                                            Select <i class="ph-bold ph-caret-right"></i>
                                        </a>
                                    </div>

                                </div>
                            </div>
                        </div>

                        </div>

                        <!-- Card Footer Removed -->

                    </div>
                </div>
            </div>
            <!-- Scraper Status Popup -->
            <!-- Removed -->
            
            <!-- Announcement Modal -->
            <div v-if="showAnnouncement" class="fixed inset-0 bg-slate-900/80 backdrop-blur-sm flex items-center justify-center z-[100] animate-fade-in p-4">
                <div class="bg-white rounded-3xl shadow-2xl max-w-lg w-full overflow-hidden transform transition-all scale-100 relative">
                    <div class="p-8">
                        <div class="prose prose-slate prose-sm max-w-none" v-html="announcementHtml"></div>
                        <button @click="showAnnouncement = false" class="mt-8 w-full bg-brand-600 hover:bg-brand-700 text-white font-bold py-3 rounded-xl transition shadow-lg shadow-brand-500/30">
                            Got it
                        </button>
                    </div>
                    <button @click="showAnnouncement = false" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600 transition">
                        <i class="ph ph-x text-xl"></i>
                    </button>
                </div>
            </div>

            <!-- Booking Warning Modal -->
            <div v-if="showBookingWarning && bookingWarningItem" class="fixed inset-0 bg-slate-900/80 backdrop-blur-sm flex items-center justify-center z-[110] animate-fade-in p-4">
                <div class="bg-white rounded-3xl shadow-2xl max-w-md w-full overflow-hidden transform transition-all scale-100 relative">
                    <div class="p-8 text-center">
                        <div class="w-16 h-16 bg-orange-100 text-orange-500 rounded-full flex items-center justify-center mx-auto mb-4 text-3xl">
                            <i class="ph ph-warning-diamond"></i>
                        </div>
                        <h3 class="text-xl font-bold text-slate-800 mb-2">Separate Tickets Required</h3>
                        <p class="text-sm text-slate-500 leading-relaxed mb-6">
                            This route involves <b>self-transferring</b>. You must book two separate tickets.
                            If your first flight is delayed, the airline is <b>not obligated</b> to get you to your final destination.
                        </p>
                        
                        <div class="space-y-3">
                            <button @click="bookFlight(bookingWarningItem.segments[0])" class="w-full flex items-center justify-between p-4 rounded-xl border border-slate-200 hover:border-brand-300 hover:bg-brand-50 transition group text-left">
                                <div>
                                    <div class="text-xs font-bold text-slate-400 uppercase">Leg 1</div>
                                    <div class="font-bold text-slate-800">{{ bookingWarningItem.segments[0].origin }} â {{ bookingWarningItem.segments[0].destination }}</div>
                                </div>
                                <div class="flex items-center gap-2 text-brand-600 font-bold text-sm">
                                    <span>${{ bookingWarningItem.segments[0].price }}</span>
                                    <i class="ph-bold ph-arrow-right group-hover:translate-x-1 transition"></i>
                                </div>
                            </button>
                            
                            <button @click="bookFlight(bookingWarningItem.segments[1])" class="w-full flex items-center justify-between p-4 rounded-xl border border-slate-200 hover:border-brand-300 hover:bg-brand-50 transition group text-left">
                                <div>
                                    <div class="text-xs font-bold text-slate-400 uppercase">Leg 2</div>
                                    <div class="font-bold text-slate-800">{{ bookingWarningItem.segments[1].origin }} â {{ bookingWarningItem.segments[1].destination }}</div>
                                </div>
                                <div class="flex items-center gap-2 text-brand-600 font-bold text-sm">
                                    <span>${{ bookingWarningItem.segments[1].price }}</span>
                                    <i class="ph-bold ph-arrow-right group-hover:translate-x-1 transition"></i>
                                </div>
                            </button>
                        </div>
                        
                        <button @click="showBookingWarning = false" class="mt-6 text-sm font-bold text-slate-400 hover:text-slate-600 transition">
                            Close
                        </button>
                    </div>
                </div>
            </div>
        </div>

            <div class="text-center py-8 px-6">
                <p class="text-[10px] text-slate-400 leading-relaxed max-w-2xl mx-auto font-medium">
                    WildFares is an independent project and is not affiliated with, endorsed by, or connected to Frontier Airlines, Inc. or the GoWild!â¢ Pass program. All trademarks are property of their respective owners.
                    <br><br>
                    <span class="font-mono text-slate-300">v2.3.0 (Mobile Beta)</span>
                    <span class="mx-2 text-slate-200">|</span>
                    <a href="/terms" class="hover:text-slate-500 transition">Terms</a>
                    <span class="mx-1 text-slate-200">â¢</span>
                    <a href="/privacy" class="hover:text-slate-500 transition">Privacy</a>
                    <span class="mx-1 text-slate-200">â¢</span>
                    <a href="mailto:David@wildfares.com" class="hover:text-slate-500 transition">Questions/Comments? David@wildfares.com</a>
                </p>
            </div>

            <!-- Bottom Navigation (Mobile Only) - Moved to root level -->
            <div v-if="!forceDesktop" class="md:hidden fixed bottom-0 left-0 w-full bg-white/90 backdrop-blur-lg border-t border-slate-200 z-[9999] flex justify-around px-2 shadow-[0_-4px_20px_rgba(0,0,0,0.1)] pb-safe" style="padding-bottom: env(safe-area-inset-bottom, 20px); height: calc(60px + env(safe-area-inset-bottom, 20px));">
                <button v-for="tab in tabs" :key="tab.id" 
                    @click="currentTab = tab.id; window.scrollTo({top: 0, behavior: 'smooth'})" 
                    class="flex flex-col items-center justify-start pt-3 flex-1 transition-all duration-200 active:scale-95 h-full"
                    :class="currentTab === tab.id ? 'text-brand-600' : 'text-slate-400'">
                    <div class="relative">
                        <i :class="[tab.icon, currentTab === tab.id ? 'ph-fill' : 'ph-bold', 'text-2xl mb-1']"></i>
                        <div v-if="currentTab === tab.id" class="absolute -bottom-1 left-1/2 -translate-x-1/2 w-1 h-1 bg-brand-600 rounded-full"></div>
                    </div>
                    <span class="text-[9px] font-bold mt-0.5">{{ tab.label }}</span>
                </button>
            </div>
        {% endraw %}
    </div>

    <script>
        const { createApp, ref, computed, watch, onMounted, nextTick } = Vue;

        const isMobileUA = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

        const clickOutside = {
            mounted(el, binding) {
                el.clickOutsideEvent = function(event) {
                    if (!(el == event.target || el.contains(event.target))) {
                        binding.value(event);
                    }
                };
                document.body.addEventListener('click', el.clickOutsideEvent);
            },
            unmounted(el) {
                document.body.removeEventListener('click', el.clickOutsideEvent);
            },
        };

        createApp({
            directives: { 'click-outside': clickOutside },
            setup() {
                // Reactive State
                const loading = ref(false);
                const error = ref(null);
                const hasSearched = ref(false);
                const mobileMenuOpen = ref(false);
                const scrolled = ref(false);
                
                // Mobile Mode Logic
                const forceDesktop = ref(!isMobileUA); // Default to desktop mode if not mobile UA
                const toggleDesktopMode = () => {
                    forceDesktop.value = !forceDesktop.value;
                    mobileMenuOpen.value = false;
                };
                
                // Config
                const currentTab = ref('explore');
                const tabs = [
                    { id: 'explore', label: 'Explore', icon: 'ph-compass', desc: 'Visual Map of Network' },
                    { id: 'oneway', label: 'One Way', icon: 'ph-airplane-takeoff', desc: 'Direct & Connecting Flights' },
                    { id: 'daytrip', label: 'Day Trips', icon: 'ph-clock-counter-clockwise', desc: 'There & Back in 1 Day' },
                    { id: 'builder', label: 'Route Builder', icon: 'ph-git-merge', desc: 'Find multi-city routings to reach sold-out destinations' }
                ];
                
                // Data Models
                const search = ref({ origin: '', dest: '', date: '' });
                const dateOptions = ref([]); // Replaces simple dates object
                const passengers = ref({ adults: 1, kids: [] });
                const showPassengerMenu = ref(false);
                const showSortDropdown = ref(false);
                const locations = ref([]);
                const routeMap = ref({});
                
                // Dropdown State
                const showOriginDropdown = ref(false);
                const showDestDropdown = ref(false);
                const showDateDropdown = ref(false);
                const destInput = ref(null);

                // Filters
                const filters = ref({ 
                    noRain: false, warm: false, nonStop: false,
                    depTime: { min: 0, max: 24 },
                    arrTime: { min: 0, max: 24 },
                    maxDuration: 24
                });
                const dayTrip = ref({ minHours: 6 });
                const dayTripMode = ref('anywhere');
                const builder = ref({ min: 1, max: 6, maxDuration: 24, maxStops: 3, sortBy: 'price' });
                const oneWay = ref({ sortBy: 'price' });
                
                // Results
                const results = ref([]);
                const searchExecuted = ref(false);
                const exploreView = ref('map');
                const exploreMode = ref('origin'); // 'origin' or 'destination'
                const allExploreFlights = ref([]);
                const weatherData = ref({});
                const selectedDest = ref(null);
                const selectedExploreCode = ref(null); // Use string code for robust selection
                const selectedFlight = ref(null);
                const selectedDayTripCity = ref(null);
                
                const showAnnouncement = ref(false);
                const announcementHtml = ref('');
                
                const showBookingWarning = ref(false);
                const bookingWarningItem = ref(null);

                const totalPassengers = computed(() => passengers.value.adults + passengers.value.kids.length);

                const addAdult = () => { if (totalPassengers.value < 9) passengers.value.adults++; };
                const removeAdult = () => { if (passengers.value.adults > 1) passengers.value.adults--; };
                const addKid = () => { if (totalPassengers.value < 9) passengers.value.kids.push(10); };
                const removeKid = (index) => passengers.value.kids.splice(index, 1);

                const openBookingModal = (item) => {
                    bookingWarningItem.value = item;
                    showBookingWarning.value = true;
                };

                const isOvernightLayover = (seg1, seg2) => {
                    if (!seg1 || !seg2) return false;
                    // Check if arrival of first leg is on a different calendar day than departure of second
                    // Note: This handles timezone shifts implicitly if we trust the ISO strings are absolute moments
                    // But Frontier API strings are usually Local.
                    // If "2023-11-21T22:00:00" (MDW) and next is "2023-11-22T06:00:00" (DEN).
                    // Simply checking the date string part YYYY-MM-DD is safest for "different calendar day".
                    const date1 = seg1.arrival.split('T')[0];
                    const date2 = seg2.departure.split('T')[0];
                    return date1 !== date2;
                };

                const getDateDiffLabel = (startIso, endIso) => {
                    if (!startIso || !endIso) return '';
                    const s = startIso.split('T')[0];
                    const e = endIso.split('T')[0];
                    if (s === e) return '';
                    const d1 = new Date(s);
                    const d2 = new Date(e);
                    const diff = Math.round((d2 - d1) / (1000 * 3600 * 24));
                    return `+${diff} Day${diff > 1 ? 's' : ''}`;
                };
                
                // Map Internals
                let mapInstance = null;
                let mapLayerGroup = null;
                let polylineGroup = null;
                let tileLayer = null;
                let originalMapView = { center: [39.8, -98.6], zoom: 4 };

                // --- Computed Properties ---

                const filteredOrigins = computed(() => {
                    const q = search.value.origin.toUpperCase();
                    // If dest is set, only show valid origins
                    let valid = null;
                    if (search.value.dest && routeMap.value) {
                        valid = new Set();
                        for (const [o, ds] of Object.entries(routeMap.value)) {
                            if (ds.includes(search.value.dest)) valid.add(o);
                        }
                    }
                    return locations.value.filter(l => {
                        if (valid && !valid.has(l.code)) return false;
                        return l.code.includes(q) || l.city.toUpperCase().includes(q);
                    });
                });

                const filteredDests = computed(() => {
                    const q = search.value.dest.toUpperCase();
                    // If origin is set AND NOT IN BUILDER MODE, only show valid dests
                    let valid = null;
                    if (currentTab.value !== 'builder' && search.value.origin && routeMap.value[search.value.origin]) {
                        valid = new Set(routeMap.value[search.value.origin]);
                    }
                    return locations.value.filter(l => {
                        if (valid && !valid.has(l.code)) return false;
                        return l.code.includes(q) || l.city.toUpperCase().includes(q);
                    });
                });

                const windowWidth = ref(window.innerWidth);
                const columns = computed(() => {
                    if (windowWidth.value >= 1280) return 4; // xl
                    if (windowWidth.value >= 1024) return 3; // lg
                    if (windowWidth.value >= 768) return 2; // md
                    return 1;
                });

                const chunkedExploreDestinations = computed(() => {
                    const allItems = Object.values(groupedExploreDestinations.value);
                    // Sort alphabetically by city name
                    allItems.sort((a, b) => a.name.localeCompare(b.name));
                    
                    const chunks = [];
                    for (let i = 0; i < allItems.length; i += columns.value) {
                        chunks.push(allItems.slice(i, i + columns.value));
                    }
                    return chunks;
                });

                const rowHasSelected = (row) => {
                    if (!selectedExploreCode.value) return false;
                    return row.some(group => group.code === selectedExploreCode.value);
                };

                const getSelectedGroupInRow = (row) => {
                    if (!selectedExploreCode.value) return null;
                    return row.find(group => group.code === selectedExploreCode.value);
                };

                const sortedOneWayResults = computed(() => {
                    if (currentTab.value !== 'oneway') return results.value;
                    const list = [...results.value];
                    
                    list.sort((a, b) => {
                        if (oneWay.value.sortBy === 'price') {
                            return (a.price || 0) - (b.price || 0);
                        } else if (oneWay.value.sortBy === 'duration') {
                            const getMinutes = (s) => {
                                if(!s) return 9999;
                                let h = 0, m = 0;
                                const parts = s.split(' ');
                                for(let p of parts) {
                                    if(p.includes('h')) h = parseInt(p);
                                    if(p.includes('m')) m = parseInt(p);
                                }
                                return h * 60 + m;
                            };
                            return getMinutes(a.duration) - getMinutes(b.duration);
                        } else if (oneWay.value.sortBy === 'stops') {
                            return (a.stops || 0) - (b.stops || 0);
                        }
                        return 0;
                    });
                    return list;
                });

                const sortedBuilderResults = computed(() => {
                    if (currentTab.value !== 'builder') return results.value;
                    const list = [...results.value];
                    
                    list.sort((a, b) => {
                        if (builder.value.sortBy === 'price') {
                            return (a.total_price || a.price) - (b.total_price || b.price);
                        } else if (builder.value.sortBy === 'duration') {
                            // Use total_duration_hours if available, otherwise parse string
                            const durA = a.total_duration_hours || 999;
                            const durB = b.total_duration_hours || 999;
                            return durA - durB;
                        } else if (builder.value.sortBy === 'stops') {
                            const stopsA = a.total_stops !== undefined ? a.total_stops : a.stops;
                            const stopsB = b.total_stops !== undefined ? b.total_stops : b.stops;
                            return stopsA - stopsB;
                        }
                        return 0;
                    });
                    return list;
                });

                const destFlights = computed(() => {
                    if (!selectedDest.value) return [];
                    const isOriginMode = exploreMode.value === 'origin';
                    return allExploreFlights.value.filter(f => {
                        // In origin mode, filter by destination; in destination mode, filter by origin
                        if (isOriginMode) {
                            const d = f.destination || (f.segments ? f.segments[f.segments.length-1].destination : null);
                            return d === selectedDest.value.code;
                        } else {
                            return f.origin === selectedDest.value.code;
                        }
                    }).sort((a,b) => (a.price||0) - (b.price||0));
                });

                const groupedDayTrips = computed(() => {
                    if (currentTab.value !== 'daytrip') return {};
                    const groups = {};
                    results.value.forEach(item => {
                        const d = item.destination; 
                        const w = weatherData.value[d];
                        
                        // Weather Filters
                        if (filters.value.noRain && w && w.condition >= 50) return;
                        if (filters.value.warm && w && toFahrenheit(w.temp) < 60) return;

                        // Nonstop Filter
                        if (filters.value.nonStop) {
                            if (item.outbound.stops > 0 || item.return.stops > 0) return;
                        }

                        if (!groups[d]) {
                            groups[d] = {
                                code: d,
                                name: getDestName(item), 
                                weather: getWeather(d),
                                flights: []
                            };
                        }
                        groups[d].flights.push(item);
                    });
                    return groups;
                });

                const sortedDayTrips = computed(() => {
                    return Object.values(groupedDayTrips.value).sort((a, b) => a.name.localeCompare(b.name));
                });

                const groupedExploreDestinations = computed(() => {
                    if (currentTab.value !== 'explore' || exploreView.value !== 'list') return {};
                    const groups = {};
                    allExploreFlights.value.forEach(f => {
                        // When in origin mode, group by destination (where you can go TO)
                        // When in destination mode, group by origin (where flights come FROM)
                        const groupBy = exploreMode.value === 'origin'
                            ? (f.destination || (f.segments ? f.segments[f.segments.length-1].destination : null))
                            : f.origin;

                        const w = weatherData.value[groupBy];

                        // Apply filters
                        if (filters.value.noRain && w && w.condition >= 50) return;
                        if (filters.value.warm && w && toFahrenheit(w.temp) < 60) return;
                        if (filters.value.nonStop && f.stops > 0) return;

                        if (!groups[groupBy]) {
                            groups[groupBy] = {
                                code: groupBy,
                                city: w?.city || groupBy,
                                name: w?.city || groupBy,
                                weather: getWeather(groupBy),
                                flights: [],
                                minPrice: 9999
                            };
                        }
                        groups[groupBy].flights.push(f);
                        const price = f.price || f.total_price || 0;
                        if (price < groups[groupBy].minPrice) {
                            groups[groupBy].minPrice = price;
                        }
                    });
                    return groups;
                });

                // --- Methods ---

                const calculateDateOptions = () => {
                    let timeZone = undefined; // Default to browser
                    
                    if (search.value.origin) {
                        const ap = locations.value.find(l => l.code === search.value.origin);
                        if (ap && ap.timezone) {
                            timeZone = ap.timezone;
                        }
                    }

                    // DETERMINE WINDOW SIZE
                    // Logic:
                    // 1. Day Trips: Always 2 days (Today, Tomorrow)
                    // 2. Others: 
                    //    - Check Origin is International?
                    //    - Check Destination is International?
                    //    - If either is true => 10 Days
                    //    - Else => 2 Days
                    
                    let windowSize = 2; // Default
                    if (currentTab.value !== 'daytrip') {
                        let isIntl = false;
                        
                        // Check Origin
                        if (search.value.origin) {
                            const o = locations.value.find(l => l.code === search.value.origin);
                            if (o && o.is_international) isIntl = true;
                        }
                        
                        // Check Destination (if applicable)
                        // In Explore mode, check based on exploreMode or target?
                        // Explore Mode:
                        //  - 'origin': we have search.origin. destination is "Anywhere" (effectively). 
                        //    Wait, if search.origin is INT, we allow 10 days. 
                        //    If search.origin is DOM, we allow 2 days (even if dest could be INT).
                        //    The Prompt says: "if choosing an international airport to depart from OR arrive to".
                        //    So if exploreMode is 'destination' (Incoming), search.origin is the target. If target is INT, then allow 10.
                        //    If exploreMode is 'origin' (Outgoing), search.origin is the source. If source is INT, then allow 10.
                        
                        // In OneWay/Builder:
                        //  - Check search.dest if set.
                        if (search.value.dest) {
                            const d = locations.value.find(l => l.code === search.value.dest);
                            if (d && d.is_international) isIntl = true;
                        }
                        
                        if (isIntl) windowSize = 10;
                    }

                    const getIsoDate = (offsetDays = 0) => {
                        const d = new Date();
                        d.setDate(d.getDate() + offsetDays);
                        const parts = new Intl.DateTimeFormat('en-US', {
                            timeZone: timeZone,
                            year: 'numeric',
                            month: '2-digit',
                            day: '2-digit'
                        }).formatToParts(d);
                        
                        const year = parts.find(p => p.type === 'year').value;
                        const month = parts.find(p => p.type === 'month').value;
                        const day = parts.find(p => p.type === 'day').value;
                        return `${year}-${month}-${day}`;
                    };

                    const options = [];
                    for(let i=0; i<windowSize; i++) {
                        const iso = getIsoDate(i);
                        // Create date object from ISO string components to avoid TZ issues
                        // We know ISO is YYYY-MM-DD
                        const [y, m, d] = iso.split('-').map(Number);
                        const localDate = new Date(y, m - 1, d); // Month is 0-indexed
                        
                        let label = i === 0 ? 'Today' : (i === 1 ? 'Tomorrow' : localDate.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' }));
                        // Manually build short date to match exactly
                        const shortDate = `${m.toString().padStart(2, '0')}/${d.toString().padStart(2, '0')}`;
                        
                        options.push({ value: iso, label: label, short: shortDate });
                    }
                    
                    dateOptions.value = options;

                    // Validate current selection
                    const validValues = new Set(options.map(o => o.value));
                    if (!search.value.date || !validValues.has(search.value.date)) {
                        search.value.date = options[0].value;
                    }
                };

                const fetchConfig = async () => {
                    try {
                        const config = await axios.get('/api/public_config');
                        if (String(config.data.announcement_enabled).toLowerCase() === 'true' && config.data.announcement_html) {
                            announcementHtml.value = config.data.announcement_html;
                            showAnnouncement.value = true;
                        }
                    } catch (e) { console.error("Config Load Failed", e); }
                };

                const init = async () => {
                    window.addEventListener('scroll', () => scrolled.value = window.scrollY > 20);
                    window.addEventListener('resize', () => windowWidth.value = window.innerWidth);

                    // 1. Fetch Config immediately
                    await fetchConfig();

                    try {
                        const [locs, routes] = await Promise.all([
                            axios.get('/api/locations'),
                            axios.get('/api/routes')
                        ]);
                        locations.value = locs.data;
                        routeMap.value = routes.data;
                        
                        // Initial calculation
                        calculateDateOptions();
                        
                    } catch (e) { console.error("Data Load Failed", e); }
                };

                const performSearch = async () => {
                    loading.value = true;
                    error.value = null;
                    results.value = [];
                    hasSearched.value = true;
                    searchExecuted.value = true;

                    // Basic Validation
                    if (!search.value.origin) {
                        error.value = "Please select an origin airport.";
                        loading.value = false;
                        return;
                    }

                    try {
                        let endpoint = '/api/search';
                        let params = { ...search.value, adt: passengers.value.adults }; 

                        if (passengers.value.kids.length > 0) {
                            params.kids = passengers.value.kids; 
                        }
                        
                        if (currentTab.value === 'daytrip') {
                            endpoint = '/api/roundtrip';
                            params.min_hours = dayTrip.value.minHours;
                            
                            if (dayTripMode.value === 'anywhere') {
                                delete params.destination;
                                delete params.dest;
                            } else {
                                if (!search.value.dest) {
                                    error.value = "Please select a destination city.";
                                    loading.value = false;
                                    return;
                                }
                                params.destination = search.value.dest;
                            }
                        }
                        else if (currentTab.value === 'builder') {
                            if (!search.value.dest) {
                                error.value = "Please select a destination.";
                                loading.value = false;
                                return;
                            }
                            endpoint = '/api/builder';
                            params.destination = params.dest;
                            params.min_layover = builder.value.min;
                            params.max_layover = 9; 
                            params.max_duration = builder.value.maxDuration;
                            params.max_stops = builder.value.maxStops;
                        }
                        else {
                             // One Way
                             if (!search.value.dest) {
                                error.value = "Please select a destination.";
                                loading.value = false;
                                return;
                            }
                             params.destination = params.dest;
                        }

                        const res = await axios.get(endpoint, { params });
                        let fetchedResults = res.data;

                        // FILTER: Remove past flights (globally if date is today)
                        if (dateOptions.value.length > 0 && search.value.date === dateOptions.value[0].value && fetchedResults.length > 0) {
                            const now = new Date();
                            const cutoff = new Date(now.getTime() + 60 * 60 * 1000); // Now + 1 Hour
                            
                            const originAirport = locations.value.find(loc => loc.code === search.value.origin);
                            if (originAirport && originAirport.timezone) {
                                const originTz = originAirport.timezone;
                                fetchedResults = fetchedResults.filter(trip => {
                                    try {
                                        const segment = trip.outbound || (trip.segments ? trip.segments[0] : trip);
                                        const depStr = segment.departure; 
                                        if(!depStr) return true;

                                        const parts = new Intl.DateTimeFormat('en-CA', { 
                                            timeZone: originTz,
                                            year: 'numeric', month: '2-digit', day: '2-digit',
                                            hour: '2-digit', minute: '2-digit', second: '2-digit',
                                            hourCycle: 'h23'
                                        }).formatToParts(cutoff);
                                        
                                        const getPart = (type) => parts.find(p => p.type === type).value;
                                        const cutoffISO = `${getPart('year')}-${getPart('month')}-${getPart('day')}T${getPart('hour')}:${getPart('minute')}:${getPart('second')}`;
                                        
                                        return depStr > cutoffISO;
                                    } catch (e) { return true; }
                                });
                            }
                        }

                        // FILTER: Seats Available
                        fetchedResults = fetchedResults.filter(f => {
                            if (f.seats_available !== undefined && f.seats_available !== null) {
                                return Number(f.seats_available) >= totalPassengers.value;
                            }
                            return true; 
                        });

                        // FILTER: One Way Time Filters
                        if (currentTab.value === 'oneway') {
                            fetchedResults = fetchedResults.filter(f => {
                                const depH = new Date(f.departure).getHours();
                                const arrH = new Date(f.arrival).getHours();
                                
                                // Helper for duration parsing if API doesn't provide number
                                let durH = f.total_duration_hours;
                                if (!durH && f.duration) {
                                    const parts = f.duration.split(' ');
                                    let h = 0, m = 0;
                                    for(let p of parts) {
                                        if(p.includes('h')) h = parseInt(p);
                                        if(p.includes('m')) m = parseInt(p);
                                    }
                                    durH = h + (m/60);
                                }

                                if (depH < filters.value.depTime.min || depH >= filters.value.depTime.max) return false;
                                if (arrH < filters.value.arrTime.min || arrH >= filters.value.arrTime.max) return false;
                                if (filters.value.maxDuration < 24 && durH && durH > filters.value.maxDuration) return false;
                                if (filters.value.nonStop && f.stops > 0) return false;
                                
                                return true;
                            });
                        }

                        results.value = fetchedResults;

                        if (currentTab.value === 'daytrip' && dayTripMode.value === 'specific' && results.value.length > 0) {
                            const dest = results.value[0].destination;
                            nextTick(() => {
                                if (groupedDayTrips.value[dest]) {
                                    selectedDayTripCity.value = groupedDayTrips.value[dest];
                                }
                            });
                        }

                        if ((currentTab.value === 'oneway' || currentTab.value === 'daytrip') && results.value.length > 0) {
                            try {
                                const wRes = await axios.get('/api/map_data', { params: { date: search.value.date } });
                                weatherData.value = {};
                                wRes.data.features.forEach(f => {
                                    weatherData.value[f.properties.code] = { ...f.properties, lat: f.geometry.coordinates[1], lon: f.geometry.coordinates[0] };
                                });
                            } catch(e) { console.log("Weather fetch failed", e); }
                        }

                    } catch (e) {
                        error.value = e.response?.data?.detail || "An unexpected error occurred.";
                    } finally {
                        loading.value = false;
                    }
                };

                const performExplore = async () => {
                    loading.value = true;
                    error.value = null;
                    hasSearched.value = true;
                    searchExecuted.value = true;
                    results.value = [];
                    selectedDest.value = null;

                    try {
                        if (exploreView.value === 'map') {
                            if (mapInstance) {
                                mapInstance.remove();
                                mapInstance = null;
                            }
                            await nextTick();
                            await initMap();
                            document.getElementById('explore-map-view')?.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        } else {
                            await fetchExploreData();
                            results.value = processExploreList();
                        }
                    } catch (e) {
                        console.error('Explore error:', e);
                        error.value = e.response?.data?.error || e.message || "Could not load map data.";
                    } finally { loading.value = false; }
                };

                const initMap = async () => {
                    const el = document.getElementById('map');
                    if (!el) return;

                    mapInstance = L.map('map').setView(originalMapView.center, originalMapView.zoom);

                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '&copy; OpenStreetMap contributors'
                    }).addTo(mapInstance);

                    mapLayerGroup = L.layerGroup().addTo(mapInstance);
                    polylineGroup = L.layerGroup().addTo(mapInstance);

                    await fetchExploreData();
                    renderMap();
                };

                const fetchExploreData = async () => {
                    const exploreType = exploreMode.value === 'origin' ? 'from' : 'to';
                    const params = { target: search.value.origin, type: exploreType, date: search.value.date };

                    const [wRes, fRes] = await Promise.all([
                        axios.get('/api/map_data', { params: { date: search.value.date } }),
                        axios.get('/api/explore_advanced', { params })
                    ]);

                    weatherData.value = {};
                    wRes.data.features.forEach(f => {
                        weatherData.value[f.properties.code] = { ...f.properties, lat: f.geometry.coordinates[1], lon: f.geometry.coordinates[0] };
                    });
                    allExploreFlights.value = fRes.data;
                };

                const filteredMapCount = ref(0);

                const renderMap = () => {
                    if (!mapInstance) return;
                    mapLayerGroup.clearLayers();
                    polylineGroup.clearLayers();

                    const centerAirport = weatherData.value[search.value.origin];
                    const isOriginMode = exploreMode.value === 'origin';

                    if (centerAirport) {
                        L.circleMarker([centerAirport.lat, centerAirport.lon], {
                            radius: 6, color: '#0ea5e9', fillColor: '#0369a1', fillOpacity: 1, weight: 2
                        }).addTo(mapLayerGroup).bindTooltip((isOriginMode ? "Departing: " : "Arriving: ") + centerAirport.code);
                    }

                    const airportsToShow = new Set();
                    allExploreFlights.value.forEach(f => {
                        let airportCode = isOriginMode
                            ? (f.destination || (f.segments ? f.segments[f.segments.length-1].destination : null))
                            : f.origin;

                        const w = weatherData.value[airportCode];
                        if (!w) return;

                        let valid = true;
                        if (filters.value.noRain && w.condition >= 50) valid = false;
                        if (filters.value.warm && toFahrenheit(w.temp) < 60) valid = false;
                        if (filters.value.nonStop && f.stops > 0) valid = false;

                        if (valid) airportsToShow.add(airportCode);
                    });
                    
                    filteredMapCount.value = airportsToShow.size;

                    airportsToShow.forEach(code => {
                        const w = weatherData.value[code];
                        if (!w || code === search.value.origin) return;

                        if (centerAirport) {
                            L.polyline([[centerAirport.lat, centerAirport.lon], [w.lat, w.lon]], {
                                color: '#94a3b8', weight: 1, dashArray: '4, 8', opacity: 0.4
                            }).addTo(polylineGroup);
                        }

                        const temp = toFahrenheit(w.temp);
                        const isRain = w.condition >= 50;
                        const emoji = isRain ? 'ð§ï¸' : 'âï¸';
                        const html = `<div class="bg-white/90 backdrop-blur border ${isRain ? 'border-blue-300' : 'border-slate-200'} rounded-lg px-0.5 py-0.5 shadow-md text-center hover:scale-110 transition transform cursor-pointer">
                            <div class="text-[9px] font-bold text-slate-900 leading-tight">${code}</div>
                            <div class="text-xs leading-none">${emoji}</div>
                            <div class="text-[8px] font-bold ${isRain ? 'text-blue-500' : 'text-orange-500'} leading-tight">${temp}Â°</div>
                        </div>`;

                        const icon = L.divIcon({ html, className: 'bg-transparent', iconSize: [38, 38] });
                        const m = L.marker([w.lat, w.lon], { icon }).addTo(mapLayerGroup);
                        m.on('click', () => {
                            selectedDest.value = w;
                        });
                    });
                };

                const processExploreList = () => {
                    const map = {};
                    allExploreFlights.value.forEach(f => {
                        let d = f.destination || (f.segments ? f.segments[f.segments.length-1].destination : null);
                         const w = weatherData.value[d];
                         if (filters.value.nonStop && f.stops > 0) return;
                         if (filters.value.noRain && w && w.condition >= 50) return;
                         if (filters.value.warm && w && toFahrenheit(w.temp) < 60) return;
                         
                         if (!map[d]) map[d] = { 
                             code: d, 
                             city: w?.city || d, 
                             price: 9999, 
                             flightCount: 0, 
                             origin: search.value.origin, 
                             destination: d, 
                             departure: f.departure, 
                             arrival: f.arrival 
                         };
                         
                         const p = f.price || f.total_price || 0;
                         if (p < map[d].price) map[d].price = p;
                         map[d].flightCount++;
                    });
                    return Object.values(map).sort((a,b) => a.price - b.price);
                };

                const filterAirports = (type) => {
                    if (type === 'origin') showOriginDropdown.value = true;
                    else showDestDropdown.value = true;
                };
                const selectAirport = (type, ap) => {
                    if (type === 'origin') {
                        search.value.origin = ap.code;
                        showOriginDropdown.value = false;
                        calculateDateOptions();
                        // Clear results when origin changes after a search
                        if (searchExecuted.value && currentTab.value !== 'explore') {
                            results.value = [];
                            searchExecuted.value = false;
                        }
                    }
                    else {
                        search.value.dest = ap.code;
                        showDestDropdown.value = false;
                        // Clear results when destination changes after a search
                        if (searchExecuted.value && currentTab.value !== 'explore') {
                            results.value = [];
                            searchExecuted.value = false;
                        }
                    }
                };
                const swapAirports = () => {
                    const t = search.value.origin; search.value.origin = search.value.dest; search.value.dest = t;
                };
                const focusDest = () => {
                     search.value.dest = ''; 
                     nextTick(() => destInput.value?.focus());
                };
                
                const getLink = (item, isRoundTrip = false) => {
                    if (!item) return '#';
                    
                    let o = item.origin || item.departure_code;
                    let d = item.destination || item.arrival_code;
                    let date = item.departure ? item.departure.split('T')[0] : search.value.date;

                    if (item.outbound) {
                        o = item.outbound.origin;
                        d = item.outbound.destination;
                        date = item.outbound.departure.split('T')[0];
                    } else {
                        if (!o && item.segments && item.segments.length > 0) o = item.segments[0].origin;
                        if (!o) o = search.value.origin;
                        if (!d && item.segments && item.segments.length > 0) d = item.segments[item.segments.length-1].destination;
                        if (!d) d = search.value.dest;
                    }

                    let url = `https://booking.flyfrontier.com/Flight/InternalSelect?o1=${o}&d1=${d}&dd1=${date}`;
                    
                    if (isRoundTrip) {
                        url += `&dd2=${date}&r=true`;
                    }

                    url += `&ADT=${passengers.value.adults}`;
                    if (passengers.value.kids.length > 0) {
                        passengers.value.kids.forEach(age => {
                            url += `&kids=${age}`;
                        });
                    }

                    url += `&umnr=false&loy=false&mon=true&ftype=GW&promo=`;
                    return url;
                };
                
                const bookFlight = (item, isRoundTrip = false) => {
                    const url = getLink(item, isRoundTrip);
                    if (url && url !== '#') window.open(url, '_blank');
                };

                const getDestCode = (item) => {
                    if (!item) return 'UNK';
                    if (item.destination) return item.destination;
                    if (item.arrival_code) return item.arrival_code;
                    if (Array.isArray(item.segments) && item.segments.length > 0) return item.segments[item.segments.length-1].destination;
                    if (item.return && item.return.origin) return item.return.origin;
                    return 'UNK';
                };
                const getDestName = (item) => {
                     const code = getDestCode(item);
                     const loc = locations.value.find(l => l.code === code);
                     return loc ? loc.city : code;
                };

                const formatTime = (iso) => {
                    if (!iso) return '--:--';
                    return new Date(iso.replace('Z','')).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                };

                const formatDateShort = (dateStr) => {
                    if (!dateStr) return '';
                    const parts = dateStr.split('-');
                    if (parts.length < 3) return dateStr;
                    return `${parts[1]}/${parts[2]}`;
                };

                const formatDurationMain = (s) => s ? s.split('(')[0].trim() : '';
                const formatDurationSub = (s) => s && s.includes('(') ? '(' + s.split('(')[1] : '';
                const toFahrenheit = (c) => Math.round((c * 9/5) + 32);
                const getWeather = (code) => {
                    if (!code || !weatherData.value || !weatherData.value[code]) return null;
                    const w = weatherData.value[code];
                    return {
                        temp: toFahrenheit(w.temp),
                        icon: w.condition >= 50 ? 'ph-cloud-rain' : 'ph-sun',
                        desc: w.condition >= 50 ? 'Rainy' : 'Clear',
                        emoji: w.condition >= 50 ? 'ð§ï¸' : 'âï¸'
                    };
                };

                const getLayoverSummary = (flight) => {
                    if (!flight.segments || flight.segments.length < 2) return '';
                    const seg = flight.segments[0];
                    if (seg && seg.destination && seg.layoverToNext && seg.layoverToNext !== 'N/A') {
                        return `via ${seg.destination} (${seg.layoverToNext})`;
                    }
                    return '';
                };

                const formatSliderTime = (h) => {
                    if (h === 24) return '12 AM';
                    const suffix = h >= 12 ? 'PM' : 'AM';
                    const hour = h % 12 || 12;
                    return `${hour} ${suffix}`;
                };

                const formatDecimalHours = (h) => {
                    if (!h) return '';
                    const hours = Math.floor(h);
                    const minutes = Math.round((h - hours) * 60);
                    return `${hours}h ${minutes}m`;
                };

                watch(currentTab, () => { 
                    results.value = []; 
                    error.value = null;
                    searchExecuted.value = false;
                    dayTripMode.value = 'anywhere';
                    selectedDayTripCity.value = null;
                    search.value.origin = '';
                    search.value.dest = '';
                    filters.value.noRain = false;
                    filters.value.warm = false;
                    filters.value.nonStop = false;
                    calculateDateOptions();
                });

                watch(() => search.value.origin, () => calculateDateOptions());
                watch(() => search.value.dest, () => calculateDateOptions());

                watch(dayTripMode, (v) => {
                    if (v === 'anywhere') {
                        search.value.dest = '';
                        results.value = [];
                        selectedDayTripCity.value = null;
                    }
                });

                watch(exploreView, (v) => {
                    selectedDest.value = null;
                    selectedExploreCode.value = null;
                    if (v === 'map') {
                        nextTick(() => initMap());
                    } else if (v === 'list' && allExploreFlights.value.length > 0) {
                        // Populate list view with existing data when switching from map
                        results.value = processExploreList();
                    }
                });

                watch(filters, () => { if (exploreView.value === 'map') renderMap(); else results.value = processExploreList(); }, { deep: true });

                watch(exploreMode, async () => {
                    if (currentTab.value === 'explore' && hasSearched.value && search.value.origin) {
                        loading.value = true;
                        selectedExploreCode.value = null;
                        selectedDest.value = null;
                        try {
                            await fetchExploreData();
                            if (exploreView.value === 'map') renderMap();
                            else results.value = processExploreList();
                        } catch(e) {
                            console.error('Failed to refresh explore data', e);
                        } finally {
                            loading.value = false;
                        }
                    }
                });

                watch(selectedDest, (newDest, oldDest) => {
                    if (!mapInstance) return;
                    if (newDest) {
                        let targetLat = newDest.lat;
                        let targetLon = newDest.lon;
                        if (window.innerWidth >= 1024) {
                            const zoom = 6;
                            const tempPoint = mapInstance.project([targetLat, targetLon], zoom);
                            const shiftAmount = window.innerWidth / 6;
                            const adjustedPoint = L.point(tempPoint.x + shiftAmount, tempPoint.y);
                            const adjustedLatLng = mapInstance.unproject(adjustedPoint, zoom);
                            targetLat = adjustedLatLng.lat;
                            targetLon = adjustedLatLng.lng;
                        }
                        // Smooth transition when switching between cities, instant when first opening
                        if (oldDest) {
                            // Switching between cities - use smooth flyTo
                            mapInstance.flyTo([targetLat, targetLon], 6, { duration: 0.6 });
                        } else {
                            // First city selected - use flyTo for initial "swoop" effect
                            mapInstance.flyTo([targetLat, targetLon], 6, { duration: 1.5 });
                        }
                    } else if (oldDest) {
                        mapInstance.setView(originalMapView.center, originalMapView.zoom);
                    }
                });

                const validateInput = (type) => {
                    setTimeout(() => {
                        const val = type === 'origin' ? search.value.origin : search.value.dest;
                        if (!val) return;
                        
                        const code = val.toUpperCase();
                        // 1. Check if it exists in raw locations
                        const location = locations.value.find(l => l.code === code);
                        
                        let isValid = !!location;

                        // 2. Check Route Validity (only for Dest, if Origin is set, and NOT in builder mode)
                        if (isValid && type === 'dest' && search.value.origin && currentTab.value !== 'builder') {
                            const validRoutes = routeMap.value[search.value.origin];
                            if (!validRoutes || !validRoutes.includes(code)) {
                                isValid = false;
                            }
                        }

                        // 3. Apply
                        if (isValid) {
                            if (type === 'origin') search.value.origin = code;
                            else search.value.dest = code;
                        } else {
                            // Clear invalid
                            if (type === 'origin') search.value.origin = '';
                            else search.value.dest = '';
                        }
                    }, 200);
                };

                onMounted(init);

                return {
                    loading, error, hasSearched, searchExecuted, mobileMenuOpen, scrolled,
                    currentTab, tabs, search, locations,
                    showOriginDropdown, showDestDropdown, showDateDropdown, filteredOrigins, filteredDests,
                    dayTrip, builder, filters, results, exploreView, exploreMode, selectedDest, destFlights, selectedFlight,
                    selectedDayTripCity, groupedDayTrips, sortedDayTrips, allExploreFlights, selectedExploreCode, groupedExploreDestinations, 
                    chunkedExploreDestinations, rowHasSelected, getSelectedGroupInRow, sortedBuilderResults, sortedOneWayResults, oneWay,
                    filterAirports, selectAirport, swapAirports, focusDest, validateInput,
                    performSearch, performExplore, getLink, formatTime, getDestCode, getDestName,
                    formatDateShort, formatDurationMain, formatDurationSub, bookFlight, getLayoverSummary, formatDecimalHours, formatSliderTime,
                    toFahrenheit, getWeatherIcon: (c) => c >= 50 ? 'ph-cloud-rain' : 'ph-sun',
                    getWeather, dayTripMode, destInput,
                    showBookingWarning, bookingWarningItem, openBookingModal, isOvernightLayover, getDateDiffLabel,
                    passengers, totalPassengers, showPassengerMenu, showSortDropdown, addAdult, removeAdult, addKid, removeKid,
                    filteredMapCount, showAnnouncement, announcementHtml, dateOptions,
                    forceDesktop, toggleDesktopMode
                };
            }
        }).mount('#app');
    </script>
</body>
</html>