<!DOCTYPE html>
<html lang="en" class="h-full bg-gray-100">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WildFares Admin Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3.2.36/dist/vue.global.prod.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <style>
        .tooltip {
            position: relative;
            display: inline-block;
        }
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 220px;
            background-color: #555;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -110px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
    </style>
</head>
<body class="h-full">
<div id="app" class="flex flex-col h-full">
    <!-- Main Content -->
    <main class="flex-1 pb-16 md:pb-0">
        <div v-if="!loggedIn" class="min-h-full flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
            <div class="max-w-md w-full space-y-8">
                <div>
                    <h2 class="mt-6 text-center text-3xl font-extrabold text-gray-900">
                        Admin Panel Login
                    </h2>
                </div>
                <form class="mt-8 space-y-6" @submit.prevent="login">
                    <div class="rounded-md shadow-sm -space-y-px">
                        <div>
                            <label for="password" class="sr-only">Password</label>
                            <input id="password" v-model="password" name="password" type="password" required class="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 focus:z-10 sm:text-sm" placeholder="Password">
                        </div>
                    </div>
                    <div>
                        <button type="submit" class="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                            Sign in
                        </button>
                    </div>
                    <p v-if="loginError" class="text-red-500 text-sm text-center">{{ loginError }}</p>
                </form>
            </div>
        </div>

        <div v-if="loggedIn" class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-3xl font-bold text-gray-800">WildFares Admin</h1>
                <span class="text-sm text-gray-500">v1.1.0</span>
            </div>
            
            <div :class="{'hidden': activeTab !== 'settings'}" class="space-y-6">
                <!-- Scraper Settings -->
                <div class="bg-white shadow-md rounded-lg p-6">
                    <h2 class="text-xl font-semibold mb-4 text-gray-700">Scraper Settings</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <setting-toggle :setting="settings.auto_scrape_enabled" title="Auto Scrape" description="Enable to automatically scrape for flights at a set interval."></setting-toggle>
                        <setting-input :setting="settings.auto_scrape_interval" title="Scrape Interval (minutes)" description="How often to run the full scraper (in minutes)." type="number"></setting-input>
                        <setting-toggle :setting="settings.midnight_scrape_enabled" title="Midnight Scrape" description="Enable to run a special scrape for each timezone as it passes midnight. This is crucial for finding next-day flights."></setting-toggle>
                        <setting-input :setting="settings.midnight_scrape_window" title="Midnight Window (minutes)" description="How long after midnight the scraper for a timezone should run (e.g., 15 for 12:00-12:15 AM)." type="number"></setting-input>
                    </div>
                </div>

                <!-- Cache Settings -->
                <div class="bg-white shadow-md rounded-lg p-6">
                    <h2 class="text-xl font-semibold mb-4 text-gray-700">Cache Settings</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <setting-input :setting="settings.scraper_cache_domestic_minutes" title="Near-Term Cache (minutes)" description="How long to cache domestic (US/Canada) flights for the next 2 days. Shorter is better for accuracy."></setting-input>
                        <setting-input :setting="settings.scraper_cache_international_hours" title="Far-Term Cache (hours)" description="How long to cache international flights for 3-10 days out. Longer is acceptable."></setting-input>
                    </div>
                </div>

                <!-- Advanced Settings -->
                <div class="bg-white shadow-md rounded-lg p-6">
                    <h2 class="text-xl font-semibold mb-4 text-gray-700">Advanced Settings</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <setting-input :setting="settings.max_concurrent_requests" title="Concurrency Limit" description="Max number of simultaneous requests the scraper can make. Higher values can be faster but risk getting blocked." type="number"></setting-input>
                        <setting-input :setting="settings.scraper_user_agent" title="User Agent" description="The User-Agent header sent with scraper requests. Should mimic a real device." type="text"></setting-input>
                        <setting-toggle :setting="settings.proxy_enabled" title="Use Proxies" description="Enable to route scraper requests through proxies configured in the 'Proxies' tab."></setting-toggle>
                    </div>
                </div>
            </div>

            <!-- Other Tabs -->
            <div v-if="activeTab !== 'settings'">
                <!-- Placeholder for other tabs like Proxies, Routes, etc. -->
                <div class="bg-white shadow-md rounded-lg p-6">
                    <h2 class="text-xl font-semibold mb-4 text-gray-700">{{ activeTab.charAt(0).toUpperCase() + activeTab.slice(1) }}</h2>
                    <p class="text-gray-600">This section is under construction.</p>
                </div>
            </div>
            
            <div class="mt-8 flex justify-end">
                <button @click="saveSettings" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out">
                    <i class="fas fa-save mr-2"></i>Save Changes
                </button>
            </div>
        </div>
    </main>

    <!-- Bottom Nav for Mobile -->
    <nav v-if="loggedIn" class="md:hidden fixed bottom-0 inset-x-0 bg-white shadow-t z-10">
        <div class="flex justify-around">
            <button @click="activeTab = 'settings'" :class="{'text-indigo-600 border-t-2 border-indigo-600': activeTab === 'settings'}" class="w-full text-center py-3 text-gray-500">
                <i class="fas fa-sliders-h"></i>
                <span class="block text-xs">Settings</span>
            </button>
            <button @click="activeTab = 'proxies'" :class="{'text-indigo-600 border-t-2 border-indigo-600': activeTab === 'proxies'}" class="w-full text-center py-3 text-gray-500">
                <i class="fas fa-server"></i>
                <span class="block text-xs">Proxies</span>
            </button>
            <button @click="activeTab = 'routes'" :class="{'text-indigo-600 border-t-2 border-indigo-600': activeTab === 'routes'}" class="w-full text-center py-3 text-gray-500">
                <i class="fas fa-route"></i>
                <span class="block text-xs">Routes</span>
            </button>
            <button @click="activeTab = 'actions'" :class="{'text-indigo-600 border-t-2 border-indigo-600': activeTab === 'actions'}" class="w-full text-center py-3 text-gray-500">
                <i class="fas fa-cogs"></i>
                <span class="block text-xs">Actions</span>
            </button>
        </div>
    </nav>
</div>

<script>
    const app = Vue.createApp({
        data() {
            return {
                loggedIn: false,
                password: '',
                loginError: '',
                settings: {},
                activeTab: 'settings' // Default tab
            };
        },
        methods: {
            async login() {
                try {
                    const response = await fetch('/api/admin/login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ password: this.password })
                    });
                    if (!response.ok) throw new Error('Login failed');
                    const data = await response.json();
                    localStorage.setItem('adminToken', data.token);
                    this.loggedIn = true;
                    this.loginError = '';
                    this.fetchData();
                } catch (error) {
                    this.loginError = 'Invalid password.';
                }
            },
            async fetchData() {
                const token = localStorage.getItem('adminToken');
                if (!token) {
                    this.loggedIn = false;
                    return;
                }
                try {
                    const response = await fetch('/api/settings', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (response.status === 401) {
                        this.loggedIn = false;
                        localStorage.removeItem('adminToken');
                        return;
                    }
                    const data = await response.json();
                    this.settings = Object.fromEntries(
                        data.map(s => [s.key, { value: s.value, original: s.value }])
                    );
                } catch (error) {
                    console.error('Error fetching settings:', error);
                }
            },
            async saveSettings() {
                const token = localStorage.getItem('adminToken');
                const changedSettings = Object.entries(this.settings)
                    .filter(([key, { value, original }]) => value !== original)
                    .map(([key, { value }]) => ({ key, value }));

                if (changedSettings.length === 0) {
                    alert('No changes to save.');
                    return;
                }

                try {
                    await Promise.all(changedSettings.map(setting =>
                        fetch('/api/settings', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${token}`
                            },
                            body: JSON.stringify(setting)
                        })
                    ));
                    alert('Settings saved successfully!');
                    this.fetchData(); // Refresh original values
                } catch (error) {
                    console.error('Error saving settings:', error);
                    alert('Failed to save settings.');
                }
            },
            checkLogin() {
                const token = localStorage.getItem('adminToken');
                if (token) {
                    this.loggedIn = true;
                    this.fetchData();
                }
            }
        },
        mounted() {
            this.checkLogin();
        }
    });

    // Reusable Setting Components
    app.component('setting-toggle', {
        props: ['setting', 'title', 'description'],
        template: `
            <div class="flex items-center justify-between">
                <div>
                    <span class="font-medium text-gray-900">{{ title }}</span>
                    <div class="tooltip inline-block ml-2">
                        <i class="fas fa-question-circle text-gray-400"></i>
                        <span class="tooltiptext">{{ description }}</span>
                    </div>
                </div>
                <button @click="setting.value = setting.value === 'true' ? 'false' : 'true'" 
                        :class="setting.value === 'true' ? 'bg-indigo-600' : 'bg-gray-200'"
                        class="relative inline-flex items-center h-6 rounded-full w-11 transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                    <span :class="setting.value === 'true' ? 'translate-x-6' : 'translate-x-1'"
                          class="inline-block w-4 h-4 transform bg-white rounded-full transition-transform"/>
                </button>
            </div>
        `
    });

    app.component('setting-input', {
        props: ['setting', 'title', 'description', 'type'],
        template: `
            <div>
                <label class="block text-sm font-medium text-gray-700">
                    {{ title }}
                    <div class="tooltip inline-block ml-1">
                        <i class="fas fa-question-circle text-gray-400"></i>
                        <span class="tooltiptext">{{ description }}</span>
                    </div>
                </label>
                <input :type="type || 'text'" v-model="setting.value" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
            </div>
        `
    });

    app.mount('#app');
</script>
</body>
</html>
