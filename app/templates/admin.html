<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WildFares Admin</title>
    <link rel="icon" type="image/png" href="/static/logo.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #f1f5f9; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        
        /* Transitions */
        .fade-enter-active, .fade-leave-active { transition: opacity 0.2s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: { 500: '#38bdf8', 600: '#0284c7' },
                        surface: { 
                            50: '#1e293b', // Card BG
                            100: '#334155', // Border/Hover
                            200: '#475569', // Text Muted
                            900: '#0f172a' // Main BG
                        }
                    }
                }
            }
        }
    </script>
</head>
<body class="h-screen flex flex-col overflow-hidden selection:bg-brand-500 selection:text-white">
    <div id="app" class="h-full flex flex-col relative">
        {% raw %}

        <!-- LOGIN -->
        <div v-if="!authenticated" class="absolute inset-0 z-50 bg-surface-900 flex items-center justify-center p-4">
            <div class="w-full max-w-sm bg-surface-50 rounded-2xl border border-surface-100 shadow-2xl p-8">
                <div class="flex flex-col items-center mb-8">
                    <div class="w-12 h-12 bg-brand-500 rounded-xl flex items-center justify-center text-white shadow-lg shadow-brand-500/20 mb-4">
                        <i class="ph-bold ph-lock-key text-2xl"></i>
                    </div>
                    <h1 class="text-xl font-bold text-white">Admin Access</h1>
                </div>
                <div class="space-y-4">
                    <input v-model="password" type="password" class="w-full bg-surface-900 border border-surface-100 rounded-xl px-4 py-3.5 text-white focus:ring-2 focus:ring-brand-500 focus:border-brand-500 outline-none transition placeholder:text-surface-200" placeholder="Enter Access Key" @keyup.enter="login">
                    <button @click="login" class="w-full bg-brand-600 hover:bg-brand-500 text-white font-bold py-3.5 rounded-xl transition shadow-lg shadow-brand-500/20 active:scale-95">Unlock</button>
                    <p v-if="loginError" class="text-center text-rose-500 text-xs font-bold mt-2 animate-pulse">{{ loginError }}</p>
                </div>
            </div>
        </div>

        <!-- APP LAYOUT -->
        <div v-else class="flex h-full flex-col lg:flex-row">
            
            <!-- SIDEBAR (Desktop) / HEADER (Mobile) -->
            <div class="lg:w-64 bg-surface-50 border-b lg:border-b-0 lg:border-r border-surface-100 flex-shrink-0 flex lg:flex-col justify-between z-20">
                
                <!-- Logo Area -->
                <div class="h-16 flex items-center px-6 border-b border-surface-100/50 bg-surface-50/50 backdrop-blur">
                    <div class="flex items-center gap-3">
                        <img src="/static/logo.png" class="w-8 h-8 rounded-md shadow-sm">
                        <span class="font-bold text-lg tracking-tight">WildFares</span>
                    </div>
                </div>

                <!-- Desktop Nav -->
                <div class="hidden lg:flex flex-1 flex-col p-4 gap-1 overflow-y-auto">
                    <nav-button v-for="tab in tabs" :key="tab.id" :item="tab" :active="activeTab === tab.id" @click="activeTab = tab.id"></nav-button>
                </div>

                <!-- Footer Stats (Desktop) -->
                <div class="hidden lg:block p-6 border-t border-surface-100/50">
                    <div class="flex items-center gap-2 mb-2">
                        <div class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></div>
                        <span class="text-xs font-bold text-surface-200 uppercase tracking-wide">Online</span>
                    </div>
                    <div class="text-[10px] text-surface-200 font-mono mb-1">UPTIME: {{ uptimeString }}</div>
                    <div class="text-[10px] text-surface-400 font-mono mb-3">VERSION: v2.4.0</div>
                    <button @click="logout" class="w-full py-2 rounded-lg bg-surface-100 hover:bg-surface-200 text-xs font-bold text-surface-200 hover:text-white transition">Logout</button>
                </div>
            </div>

            <!-- MAIN CONTENT -->
            <div class="flex-1 bg-surface-900 overflow-hidden flex flex-col relative">
                
                <!-- Top Bar (Context) -->
                <header class="h-16 border-b border-surface-100 flex items-center justify-between px-6 bg-surface-900/95 backdrop-blur z-10">
                    <div>
                        <h2 class="text-lg font-bold text-white">{{ currentTabLabel }}</h2>
                    </div>
                    <div class="flex items-center gap-3">
                        <button @click="fetchData" class="p-2 text-surface-200 hover:text-white hover:bg-surface-100 rounded-lg transition" title="Refresh Data">
                            <i class="ph-bold ph-arrows-clockwise text-lg"></i>
                        </button>
                        <a href="/" target="_blank" class="hidden md:flex items-center gap-2 px-3 py-1.5 bg-brand-600/10 text-brand-500 rounded-lg text-xs font-bold hover:bg-brand-600 hover:text-white transition">
                            Live Site <i class="ph-bold ph-arrow-square-out"></i>
                        </a>
                    </div>
                </header>

                <!-- Scrollable Area -->
                <main class="flex-1 overflow-y-auto p-4 pb-24 lg:p-8 lg:pb-8">
                    
                    <!-- DASHBOARD -->
                    <div v-if="activeTab === 'dashboard'" class="space-y-6 max-w-6xl mx-auto animate-fade-in">
                        <!-- KPI Grid -->
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <kpi-card icon="ph-database" color="emerald" :value="cacheCount" label="Cached Flights"></kpi-card>
                            <kpi-card icon="ph-shield-check" color="blue" :value="activeProxiesCount" label="Active Proxies"></kpi-card>
                            <kpi-card icon="ph-robot" color="orange" :value="settings.auto_scrape_enabled === 'true' ? 'ON' : 'OFF'" label="Auto Scraper"></kpi-card>
                            <kpi-card icon="ph-clock" color="purple" :value="settings.last_auto_scrape ? formatSmartTime(settings.last_auto_scrape) : 'Never'" label="Last Run" class="truncate"></kpi-card>
                        </div>

                        <!-- Controls -->
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <!-- Actions -->
                            <div class="bg-surface-50 rounded-2xl border border-surface-100 p-6">
                                <h3 class="text-sm font-bold text-surface-200 uppercase tracking-wider mb-4">System Control</h3>
                                <div class="space-y-3">
                                    <action-button icon="ph-play" label="Trigger Auto Scraper" @click="runAutoScraper"></action-button>
                                    <action-button icon="ph-arrows-clockwise" label="Update Route Map" @click="updateRoutes" :loading="routeJob.status === 'running'" :subtext="routeJob.message"></action-button>
                                    <action-button icon="ph-cloud-sun" label="Update Weather" @click="triggerWeatherUpdate"></action-button>
                                    <div class="grid grid-cols-2 gap-3 pt-2">
                                        <button @click="clearCache" class="py-2.5 rounded-xl bg-surface-100 hover:bg-rose-500/20 hover:text-rose-400 hover:border-rose-500/50 border border-surface-100 text-xs font-bold text-surface-200 transition flex justify-center items-center gap-2"><i class="ph-bold ph-trash"></i> Clear Cache</button>
                                        <button @click="rebootBackend" class="py-2.5 rounded-xl bg-surface-100 hover:bg-white/5 border border-surface-100 text-xs font-bold text-surface-200 hover:text-white transition flex justify-center items-center gap-2"><i class="ph-bold ph-power"></i> Reboot</button>
                                    </div>
                                </div>
                            </div>
                            <!-- Quick Settings -->
                            <div class="bg-surface-50 rounded-2xl border border-surface-100 p-6">
                                <h3 class="text-sm font-bold text-surface-200 uppercase tracking-wider mb-4">Quick Config</h3>
                                <div class="space-y-4">
                                    <toggle-switch v-model="settings.auto_scrape_enabled" label="Auto Scraper"></toggle-switch>
                                    <toggle-switch v-model="settings.proxy_enabled" label="Use Proxies"></toggle-switch>
                                    <toggle-switch v-model="settings.scraper_jitter_enabled" label="Scraper Jitter (Stealth)"></toggle-switch>
                                    <div class="pt-4 mt-4 border-t border-surface-100">
                                        <button @click="saveSettings" class="w-full bg-white text-surface-900 font-bold py-3 rounded-xl hover:bg-brand-500 hover:text-white transition">Save Changes</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Scraper Run History -->
                        <div class="bg-surface-50 rounded-2xl border border-surface-100 p-6">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-sm font-bold text-surface-200 uppercase tracking-wider">Scraper Run History</h3>
                                <button @click="fetchScraperRuns" class="text-xs text-brand-400 hover:text-brand-300 transition"><i class="ph-bold ph-arrows-clockwise"></i> Refresh</button>
                            </div>
                            <div class="space-y-2">
                                <div v-if="scraperRuns.length === 0" class="text-center py-8 text-surface-200 text-sm">
                                    No scraper runs yet
                                </div>
                                <div v-for="run in scraperRuns" :key="run.id" class="bg-surface-900 rounded-xl border border-surface-100 p-4 hover:border-brand-500/30 transition">
                                    <div class="flex items-start justify-between mb-2">
                                        <div class="flex items-center gap-2">
                                            <div class="w-2 h-2 rounded-full" :class="{
                                                'bg-emerald-500': run.status === 'completed',
                                                'bg-rose-500': run.status === 'failed',
                                                'bg-blue-500 animate-pulse': run.status === 'running'
                                            }"></div>
                                            <span class="text-xs font-bold text-white">Run #{{ run.id }}</span>
                                            <span class="text-[10px] text-surface-200 font-mono">{{ formatSmartTime(run.started_at) }}</span>
                                        </div>
                                        <div class="flex items-center gap-2">
                                            <span class="text-xs font-bold px-2 py-1 rounded-lg" :class="{
                                                'bg-emerald-500/20 text-emerald-400': run.status === 'completed',
                                                'bg-rose-500/20 text-rose-400': run.status === 'failed',
                                                'bg-blue-500/20 text-blue-400': run.status === 'running'
                                            }">{{ run.status.toUpperCase() }}</span>
                                            <span class="text-[10px] text-surface-200 font-mono">{{ formatDuration(run.duration_seconds) }}</span>
                                        </div>
                                    </div>
                                    <div class="grid grid-cols-4 gap-3 mt-3">
                                        <div class="text-center">
                                            <div class="text-xs font-bold text-white">{{ run.total_routes || 0 }}</div>
                                            <div class="text-[10px] text-surface-200 uppercase">Total</div>
                                        </div>
                                        <div class="text-center">
                                            <div class="text-xs font-bold text-emerald-400">{{ run.routes_scraped || 0 }}</div>
                                            <div class="text-[10px] text-surface-200 uppercase">Scraped</div>
                                        </div>
                                        <div class="text-center">
                                            <div class="text-xs font-bold text-blue-400">{{ run.routes_skipped || 0 }}</div>
                                            <div class="text-[10px] text-surface-200 uppercase">Skipped</div>
                                        </div>
                                        <div class="text-center">
                                            <div class="text-xs font-bold text-rose-400">{{ run.routes_failed || 0 }}</div>
                                            <div class="text-[10px] text-surface-200 uppercase">Failed</div>
                                        </div>
                                    </div>
                                    <div v-if="run.error_message" class="mt-3 text-[10px] text-rose-400 font-mono bg-rose-500/10 rounded-lg p-2 border border-rose-500/20">
                                        {{ run.error_message }}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- SCRAPER TOOL -->
                    <div v-if="activeTab === 'scraper'" class="max-w-4xl mx-auto animate-fade-in">
                        <div class="bg-surface-50 rounded-2xl border border-surface-100 overflow-hidden">
                            <div class="p-6 border-b border-surface-100">
                                <h3 class="text-lg font-bold text-white">Manual Route Scraper</h3>
                                <p class="text-xs text-surface-200 mt-1">Force refresh a specific route and date directly from the airline API.</p>
                            </div>
                            <div class="p-6 space-y-6">
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div>
                                        <label class="block text-xs font-bold text-surface-200 uppercase mb-2">Origin</label>
                                        <input v-model="manualScrape.origin" type="text" class="w-full bg-surface-900 border border-surface-100 rounded-xl px-4 py-3 text-white font-bold uppercase placeholder:text-surface-200 focus:border-brand-500 outline-none" placeholder="LAS">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-bold text-surface-200 uppercase mb-2">Destination</label>
                                        <input v-model="manualScrape.destination" type="text" class="w-full bg-surface-900 border border-surface-100 rounded-xl px-4 py-3 text-white font-bold uppercase placeholder:text-surface-200 focus:border-brand-500 outline-none" placeholder="DEN">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-bold text-surface-200 uppercase mb-2">Date (YYYY-MM-DD)</label>
                                        <input v-model="manualScrape.date" type="date" class="w-full bg-surface-900 border border-surface-100 rounded-xl px-4 py-3 text-white font-bold focus:border-brand-500 outline-none">
                                    </div>
                                </div>
                                <button @click="runManualScrape" :disabled="manualScrape.loading" class="w-full bg-brand-600 hover:bg-brand-500 disabled:opacity-50 disabled:cursor-not-allowed text-white font-bold py-4 rounded-xl shadow-lg shadow-brand-500/20 transition flex items-center justify-center gap-2">
                                    <i v-if="manualScrape.loading" class="ph-bold ph-spinner animate-spin"></i>
                                    <span>{{ manualScrape.loading ? 'Scraping...' : 'Run Scraper' }}</span>
                                </button>

                                <!-- Result Area -->
                                <div v-if="manualScrape.result" class="mt-6 bg-surface-900 rounded-xl border border-surface-100 p-4 overflow-hidden relative group">
                                    <div class="absolute top-2 right-2">
                                        <button @click="manualScrape.result = null" class="text-surface-200 hover:text-white"><i class="ph-bold ph-x"></i></button>
                                    </div>
                                    <div class="text-xs font-bold text-emerald-400 mb-2 flex items-center gap-2">
                                        <i class="ph-bold ph-check-circle"></i> Success
                                    </div>
                                    <pre class="text-[10px] font-mono text-surface-200 overflow-x-auto max-h-64 custom-scrollbar">{{ JSON.stringify(manualScrape.result, null, 2) }}</pre>
                                </div>
                                <div v-if="manualScrape.error" class="mt-6 bg-rose-500/10 border border-rose-500/30 rounded-xl p-4 text-rose-400 text-sm font-bold flex items-center gap-3">
                                    <i class="ph-bold ph-warning-circle text-xl"></i> {{ manualScrape.error }}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ROUTES MANAGER (NEW) -->
                    <div v-if="activeTab === 'routes'" class="max-w-6xl mx-auto animate-fade-in">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xl font-bold text-white">Route Manager</h3>
                            <div class="flex bg-surface-50 rounded-lg p-1 border border-surface-100 shadow-sm gap-1">
                                <button @click="routeSort = 'origin'" :class="routeSort === 'origin' ? 'bg-surface-200 text-white' : 'text-surface-200 hover:bg-surface-100'" class="px-3 py-1.5 rounded text-xs font-bold transition">By Origin</button>
                                <button @click="routeSort = 'errors'" :class="routeSort === 'errors' ? 'bg-surface-200 text-white' : 'text-surface-200 hover:bg-surface-100'" class="px-3 py-1.5 rounded text-xs font-bold transition">Most Errors</button>
                            </div>
                        </div>

                        <div v-if="isLoadingRoutes" class="p-12 flex justify-center text-brand-500 text-3xl">
                            <i class="ph-bold ph-spinner animate-spin"></i>
                        </div>

                        <div v-else class="bg-surface-50 rounded-2xl border border-surface-100 overflow-hidden">
                            <div class="overflow-x-auto">
                                <table class="w-full text-left border-collapse">
                                    <thead>
                                        <tr class="bg-surface-100 text-[10px] font-bold text-surface-200 uppercase">
                                            <th class="px-6 py-3">Status</th>
                                            <th class="px-6 py-3">Route</th>
                                            <th class="px-6 py-3 text-right">Error Count</th>
                                            <th class="px-6 py-3 text-right">Last Validated</th>
                                            <th class="px-6 py-3 text-right">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-surface-100 text-xs">
                                        <tr v-for="r in sortedRoutes" :key="r.id" class="hover:bg-surface-100/50 transition" :class="!r.is_active ? 'opacity-50' : ''">
                                            <td class="px-6 py-3">
                                                <span :class="r.is_active ? 'text-emerald-400' : 'text-surface-400'" class="flex items-center gap-1.5 font-bold">
                                                    <div class="w-1.5 h-1.5 rounded-full" :class="r.is_active ? 'bg-emerald-400' : 'bg-surface-400'"></div>
                                                    {{ r.is_active ? 'Active' : 'Inactive' }}
                                                </span>
                                            </td>
                                            <td class="px-6 py-3 font-bold text-white">{{ r.origin }} <span class="text-surface-200 mx-1">→</span> {{ r.destination }}</td>
                                            <td class="px-6 py-3 text-right">
                                                <span :class="r.error_count > 0 ? 'text-rose-400' : 'text-surface-200'" class="font-mono font-bold">{{ r.error_count }}</span>
                                            </td>
                                            <td class="px-6 py-3 text-right text-surface-200 font-mono">{{ r.last_validated ? formatSmartTime(r.last_validated) : '-' }}</td>
                                            <td class="px-6 py-3 text-right">
                                                <button @click="toggleRoute(r)" class="px-3 py-1 rounded bg-surface-200 hover:bg-white text-surface-900 font-bold text-[10px] transition">
                                                    {{ r.is_active ? 'Disable' : 'Enable' }}
                                                </button>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- DATA EXPLORER -->
                    <div v-if="activeTab === 'data'" class="max-w-6xl mx-auto animate-fade-in">
                        <div class="flex gap-2 mb-6 overflow-x-auto pb-2">
                            <button @click="explorerMode = 'flights'" :class="explorerMode === 'flights' ? 'bg-brand-600 text-white' : 'bg-surface-50 text-surface-200 hover:text-white'" class="px-4 py-2 rounded-lg text-xs font-bold transition whitespace-nowrap">Flights</button>
                            <button @click="explorerMode = 'weather'" :class="explorerMode === 'weather' ? 'bg-orange-600 text-white' : 'bg-surface-50 text-surface-200 hover:text-white'" class="px-4 py-2 rounded-lg text-xs font-bold transition whitespace-nowrap">Weather</button>
                            <button @click="explorerMode = 'seats'" :class="explorerMode === 'seats' ? 'bg-purple-600 text-white' : 'bg-surface-50 text-surface-200 hover:text-white'" class="px-4 py-2 rounded-lg text-xs font-bold transition whitespace-nowrap">Inventory</button>
                        </div>

                        <div class="bg-surface-50 rounded-2xl border border-surface-100 overflow-hidden">
                            <!-- Flights -->
                            <div v-if="explorerMode === 'flights'" class="divide-y divide-surface-100">
                                <div v-for="(origins, date) in explorerData.flights" :key="date">
                                    <div @click="toggleExpand(date)" class="px-6 py-4 hover:bg-surface-100 cursor-pointer flex justify-between items-center transition">
                                        <span class="font-mono font-bold text-white text-sm">{{ date }}</span>
                                        <div class="flex items-center gap-4">
                                            <span class="text-xs font-bold text-surface-200">{{ Object.keys(origins).length }} Origins</span>
                                            <button @click.stop="deleteDate('cached_routes', date)" class="text-surface-200 hover:text-rose-500"><i class="ph-bold ph-trash"></i></button>
                                        </div>
                                    </div>
                                    <div v-if="expanded[date]" class="bg-surface-900/50 p-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 border-t border-surface-100">
                                        <div v-for="(dests, origin) in origins" :key="origin" class="bg-surface-50 border border-surface-100 rounded-lg p-3">
                                            <div class="flex justify-between items-center mb-2 border-b border-surface-100 pb-2">
                                                <span class="text-brand-500 font-bold text-xs">{{ origin }}</span>
                                                <span class="text-[10px] text-surface-200">{{ Object.keys(dests).length }} dests</span>
                                            </div>
                                            <div class="space-y-1 max-h-32 overflow-y-auto no-scrollbar">
                                                <div v-for="(d, dest) in dests" :key="dest" class="flex justify-between text-[10px] text-surface-200">
                                                    <span>{{ dest }}</span>
                                                    <span class="text-white font-mono">{{ d.count }}</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Weather -->
                            <div v-if="explorerMode === 'weather'" class="divide-y divide-surface-100">
                                <div v-for="(airports, date) in explorerData.weather" :key="date">
                                    <div @click="toggleExpand(date)" class="px-6 py-4 hover:bg-surface-100 cursor-pointer flex justify-between items-center transition">
                                        <span class="font-mono font-bold text-white text-sm">{{ date }}</span>
                                        <div class="flex items-center gap-4">
                                            <span class="text-xs font-bold text-surface-200">{{ airports.length }} Airports</span>
                                            <button @click.stop="deleteDate('weather_data', date)" class="text-surface-200 hover:text-rose-500"><i class="ph-bold ph-trash"></i></button>
                                        </div>
                                    </div>
                                    <div v-if="expanded[date]" class="bg-surface-900/50 p-4 border-t border-surface-100">
                                        <div class="grid grid-cols-2 sm:grid-cols-4 md:grid-cols-6 gap-2">
                                            <div v-for="a in airports" :key="a.airport" class="bg-surface-50 p-2 rounded text-center">
                                                <div class="text-xs font-bold text-white">{{ a.airport }}</div>
                                                <div class="text-[10px] text-surface-200">{{ a.temp }}° ({{ a.condition }})</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Seats -->
                            <div v-if="explorerMode === 'seats'" class="overflow-x-auto">
                                <table class="w-full text-left border-collapse">
                                    <thead>
                                        <tr class="bg-surface-100 text-[10px] font-bold text-surface-200 uppercase">
                                            <th class="px-6 py-3">Date</th>
                                            <th class="px-6 py-3">Route</th>
                                            <th class="px-6 py-3">Flight</th>
                                            <th class="px-6 py-3 text-right">Seats</th>
                                            <th class="px-6 py-3 text-right">Price</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-surface-100 text-xs">
                                        <tr v-for="(row, i) in seatInventory" :key="i" class="hover:bg-surface-100/50 transition">
                                            <td class="px-6 py-3 font-mono text-surface-200">{{ row.date }}</td>
                                            <td class="px-6 py-3 font-bold text-white">{{ row.origin }} → {{ row.destination }}</td>
                                            <td class="px-6 py-3 text-surface-200">{{ row.flight }}</td>
                                            <td class="px-6 py-3 text-right font-bold" :class="row.seats > 0 ? 'text-emerald-400' : 'text-rose-400'">{{ row.seats }}</td>
                                            <td class="px-6 py-3 text-right font-mono text-white">${{ row.price }}</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- SETTINGS & PROXIES -->
                    <div v-if="activeTab === 'settings'" class="max-w-6xl mx-auto animate-fade-in space-y-8">
                        <!-- Config -->
                        <div class="bg-surface-50 rounded-2xl border border-surface-100 p-6">
                            <h3 class="text-lg font-bold text-white mb-6 border-b border-surface-100 pb-4">System Configuration</h3>

                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                                <!-- LEFT COLUMN -->
                                <div class="space-y-8">
                                    <!-- Announcement Settings -->
                                    <div>
                                        <h4 class="text-xs font-bold text-surface-200 uppercase mb-4 flex items-center gap-2">
                                            <i class="ph-bold ph-megaphone"></i> Announcement
                                        </h4>
                                        <div class="space-y-4">
                                            <toggle-switch v-model="settings.announcement_enabled" label="Enable Announcement"></toggle-switch>
                                            <div>
                                                <label class="block text-xs font-bold text-surface-200 uppercase mb-2">HTML Content</label>
                                                <textarea v-model="settings.announcement_html" class="w-full bg-surface-900 border border-surface-100 rounded-lg px-3 py-2.5 text-white text-xs font-mono h-32 outline-none focus:border-brand-500"></textarea>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Auto Scraper Settings -->
                                    <div>
                                        <h4 class="text-xs font-bold text-surface-200 uppercase mb-4 flex items-center gap-2">
                                            <i class="ph-bold ph-robot"></i> Auto Scraper
                                        </h4>
                                        <div class="space-y-4">
                                            <toggle-switch v-model="settings.schedule_auto_enabled" label="Enable Auto Scraper"></toggle-switch>
                                            <div class="grid grid-cols-2 gap-4">
                                                <div>
                                                    <label class="block text-xs font-bold text-surface-200 uppercase mb-2">Interval (Min)</label>
                                                    <input v-model="settings.schedule_auto_interval" type="number" class="w-full bg-surface-900 border border-surface-100 rounded-lg px-3 py-2.5 text-white text-sm outline-none focus:border-brand-500">
                                                </div>
                                                <div>
                                                    <label class="block text-xs font-bold text-surface-200 uppercase mb-2">Stale Cache (Min)</label>
                                                    <input v-model="settings.scraper_stale_minutes" type="number" class="w-full bg-surface-900 border border-surface-100 rounded-lg px-3 py-2.5 text-white text-sm outline-none focus:border-brand-500">
                                                </div>
                                                <div>
                                                    <label class="block text-xs font-bold text-surface-200 uppercase mb-2">Max Workers</label>
                                                    <input v-model="settings.max_concurrent_requests" type="number" class="w-full bg-surface-900 border border-surface-100 rounded-lg px-3 py-2.5 text-white text-sm outline-none focus:border-brand-500">
                                                </div>
                                                <div>
                                                    <label class="block text-xs font-bold text-surface-200 uppercase mb-2">Timeout (Sec)</label>
                                                    <input v-model="settings.scraper_timeout" type="number" class="w-full bg-surface-900 border border-surface-100 rounded-lg px-3 py-2.5 text-white text-sm outline-none focus:border-brand-500">
                                                </div>
                                            </div>
                                            <div>
                                                <label class="block text-xs font-bold text-surface-200 uppercase mb-2">User Agent</label>
                                                <input v-model="settings.scraper_user_agent" type="text" class="w-full bg-surface-900 border border-surface-100 rounded-lg px-3 py-2.5 text-white text-sm outline-none focus:border-brand-500">
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Midnight Scraper Settings -->
                                    <div>
                                        <h4 class="text-xs font-bold text-surface-200 uppercase mb-4 flex items-center gap-2">
                                            <i class="ph-bold ph-moon"></i> Midnight Scraper
                                        </h4>
                                        <div class="space-y-4">
                                            <toggle-switch v-model="settings.schedule_midnight_enabled" label="Enable Midnight Scraper"></toggle-switch>
                                            <div>
                                                <label class="block text-xs font-bold text-surface-200 uppercase mb-2">Check Interval (Min)</label>
                                                <input v-model="settings.schedule_midnight_interval" type="number" class="w-full bg-surface-900 border border-surface-100 rounded-lg px-3 py-2.5 text-white text-sm outline-none focus:border-brand-500">
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Weather Scraper Settings -->
                                    <div>
                                        <h4 class="text-xs font-bold text-surface-200 uppercase mb-4 flex items-center gap-2">
                                            <i class="ph-bold ph-cloud-sun"></i> Weather Scraper
                                        </h4>
                                        <div class="space-y-4">
                                            <toggle-switch v-model="settings.schedule_weather_enabled" label="Enable Weather Scraper"></toggle-switch>
                                            <div>
                                                <label class="block text-xs font-bold text-surface-200 uppercase mb-2">Run Time (UTC)</label>
                                                <input v-model="settings.schedule_weather_time" type="time" class="w-full bg-surface-900 border border-surface-100 rounded-lg px-3 py-2.5 text-white text-sm outline-none focus:border-brand-500">
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Three Week Scraper Settings -->
                                    <div>
                                        <h4 class="text-xs font-bold text-surface-200 uppercase mb-4 flex items-center gap-2">
                                            <i class="ph-bold ph-calendar-dots"></i> 3-Week Scraper
                                        </h4>
                                        <div class="space-y-4">
                                            <toggle-switch v-model="settings.schedule_3week_enabled" label="Enable 3-Week Scraper"></toggle-switch>
                                            <div>
                                                <label class="block text-xs font-bold text-surface-200 uppercase mb-2">Run Time (UTC)</label>
                                                <input v-model="settings.schedule_3week_time" type="time" class="w-full bg-surface-900 border border-surface-100 rounded-lg px-3 py-2.5 text-white text-sm outline-none focus:border-brand-500">
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Route Sync Settings -->
                                    <div>
                                        <h4 class="text-xs font-bold text-surface-200 uppercase mb-4 flex items-center gap-2">
                                            <i class="ph-bold ph-map-pin-line"></i> Route Sync
                                        </h4>
                                        <div class="space-y-4">
                                            <toggle-switch v-model="settings.schedule_route_sync_enabled" label="Enable Route Sync"></toggle-switch>
                                            <div>
                                                <label class="block text-xs font-bold text-surface-200 uppercase mb-2">Run Time (UTC)</label>
                                                <input v-model="settings.schedule_route_sync_time" type="time" class="w-full bg-surface-900 border border-surface-100 rounded-lg px-3 py-2.5 text-white text-sm outline-none focus:border-brand-500">
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- RIGHT COLUMN -->
                                <div class="space-y-8">
                                    <!-- Cache Settings -->
                                    <div>
                                        <h4 class="text-xs font-bold text-surface-200 uppercase mb-4 flex items-center gap-2">
                                            <i class="ph-bold ph-database"></i> Cache Management
                                        </h4>
                                        <div class="space-y-4">
                                            <div>
                                                <label class="block text-xs font-bold text-surface-200 uppercase mb-2">Cache Duration (Min)</label>
                                                <input v-model="settings.cache_duration_minutes" type="number" class="w-full bg-surface-900 border border-surface-100 rounded-lg px-3 py-2.5 text-white text-sm outline-none focus:border-brand-500">
                                            </div>
                                            <toggle-switch v-model="settings.cache_reset_enabled" label="Enable Scheduled Cache Reset"></toggle-switch>
                                            <div class="grid grid-cols-2 gap-4">
                                                <div>
                                                    <label class="block text-xs font-bold text-surface-200 uppercase mb-2">Reset Every (Days)</label>
                                                    <input v-model="settings.cache_reset_days" type="number" class="w-full bg-surface-900 border border-surface-100 rounded-lg px-3 py-2.5 text-white text-sm outline-none focus:border-brand-500">
                                                </div>
                                                <div>
                                                    <label class="block text-xs font-bold text-surface-200 uppercase mb-2">Reset Time</label>
                                                    <input v-model="settings.cache_reset_time" type="time" class="w-full bg-surface-900 border border-surface-100 rounded-lg px-3 py-2.5 text-white text-sm outline-none focus:border-brand-500">
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Proxy Settings -->
                                    <div>
                                        <h4 class="text-xs font-bold text-surface-200 uppercase mb-4 flex items-center gap-2">
                                            <i class="ph-bold ph-shield-check"></i> Proxy Configuration
                                        </h4>
                                        <div class="space-y-4">
                                            <toggle-switch v-model="settings.proxy_enabled" label="Enable Proxy Rotation"></toggle-switch>
                                            <div>
                                                <label class="block text-xs font-bold text-surface-200 uppercase mb-2">Current Proxy Index</label>
                                                <input v-model="settings.proxy_index" type="number" class="w-full bg-surface-900 border border-surface-100 rounded-lg px-3 py-2.5 text-white text-sm outline-none focus:border-brand-500">
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Safety & Stealth -->
                                    <div>
                                        <h4 class="text-xs font-bold text-surface-200 uppercase mb-4 flex items-center gap-2">
                                            <i class="ph-bold ph-eye-slash"></i> Safety & Stealth
                                        </h4>
                                        <div class="space-y-4">
                                            <toggle-switch v-model="settings.scraper_jitter_enabled" label="Enable Random Delay (Jitter)"></toggle-switch>
                                            <div v-if="settings.scraper_jitter_enabled === 'true'" class="grid grid-cols-2 gap-4 animate-fade-in">
                                                <div>
                                                    <label class="block text-xs font-bold text-surface-200 uppercase mb-2">Min Delay (Sec)</label>
                                                    <input v-model="settings.scraper_jitter_min" type="number" step="0.1" class="w-full bg-surface-900 border border-surface-100 rounded-lg px-3 py-2.5 text-white text-sm outline-none focus:border-brand-500">
                                                </div>
                                                <div>
                                                    <label class="block text-xs font-bold text-surface-200 uppercase mb-2">Max Delay (Sec)</label>
                                                    <input v-model="settings.scraper_jitter_max" type="number" step="0.1" class="w-full bg-surface-900 border border-surface-100 rounded-lg px-3 py-2.5 text-white text-sm outline-none focus:border-brand-500">
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Debug Settings -->
                                    <div>
                                        <h4 class="text-xs font-bold text-surface-200 uppercase mb-4 flex items-center gap-2">
                                            <i class="ph-bold ph-bug"></i> Debug & Logging
                                        </h4>
                                        <div class="space-y-4">
                                            <toggle-switch v-model="settings.debug_logging_enabled" label="Enable Debug Logging"></toggle-switch>
                                            <toggle-switch v-model="settings.save_debug_responses" label="Save Debug Responses"></toggle-switch>
                                        </div>
                                    </div>

                                    <!-- Blackout Dates -->
                                    <div>
                                        <h4 class="text-xs font-bold text-surface-200 uppercase mb-4 flex items-center gap-2">
                                            <i class="ph-bold ph-calendar-x"></i> Blackout Dates
                                        </h4>
                                        <div class="space-y-4">
                                            <toggle-switch v-model="settings.blackout_dates_enabled" label="Enable Blackout Warnings"></toggle-switch>
                                            <div>
                                                <label class="block text-xs font-bold text-surface-200 uppercase mb-2">Dates (JSON List)</label>
                                                <textarea v-model="settings.blackout_dates" class="w-full bg-surface-900 border border-surface-100 rounded-lg px-3 py-2.5 text-white text-xs font-mono h-32 outline-none focus:border-brand-500" placeholder='["2025-01-01", "2025-01-02"]'></textarea>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="mt-8 pt-6 border-t border-surface-100 flex justify-end gap-4">
                                <button @click="fetchData" class="bg-surface-100 text-white font-bold py-2.5 px-6 rounded-lg hover:bg-surface-200 transition">Reset</button>
                                <button @click="saveSettings" class="bg-brand-600 text-white font-bold py-2.5 px-8 rounded-lg hover:bg-brand-500 transition shadow-lg shadow-brand-500/20">Save All Settings</button>
                            </div>
                        </div>

                        <!-- Proxies -->
                        <div class="bg-surface-50 rounded-2xl border border-surface-100 p-6">
                            <div class="flex justify-between items-center mb-6 border-b border-surface-100 pb-4">
                                <h3 class="text-lg font-bold text-white">Proxies</h3>
                                <div class="flex gap-4">
                                    <button @click="recheckProxies" class="text-xs font-bold text-brand-400 hover:text-brand-300 transition">Recheck</button>
                                    <button @click="deleteAllProxies" class="text-xs font-bold text-rose-400 hover:text-rose-300 transition">Delete All</button>
                                </div>
                            </div>
                            <div class="flex flex-col md:flex-row gap-3 mb-4">
                                <textarea v-model="newProxies" placeholder="host:port:user:pass (one per line)" class="flex-1 bg-surface-900 border border-surface-100 rounded-lg px-3 py-2.5 text-white text-xs font-mono outline-none focus:border-brand-500 min-h-[80px]"></textarea>
                                <button @click="addProxies" class="bg-brand-600 text-white font-bold px-6 py-2 rounded-lg hover:bg-brand-500 transition flex items-center justify-center shadow-lg shadow-brand-500/20">Add</button>
                            </div>
                            <div class="space-y-2 max-h-96 overflow-y-auto custom-scrollbar">
                                <div v-for="p in proxies" :key="p.id" class="flex justify-between items-start bg-surface-900 p-3 rounded-lg border border-surface-100">
                                    <div class="flex items-start gap-3 overflow-hidden">
                                        <div class="w-2 h-2 rounded-full flex-shrink-0 mt-1" :class="p.is_active ? 'bg-emerald-500' : 'bg-rose-500'"></div>
                                        <span class="text-xs font-mono text-surface-200 break-all">{{ p.url }}</span>
                                    </div>
                                    <button @click="deleteProxy(p.id)" class="text-surface-200 hover:text-rose-400 ml-2"><i class="ph-bold ph-trash"></i></button>
                                </div>
                                <div v-if="proxies.length === 0" class="text-center text-xs text-surface-200 py-4">No proxies defined.</div>
                            </div>
                        </div>
                    </div>

                </main>
            </div>

            <!-- BOTTOM NAV (Mobile) -->
            <div class="lg:hidden fixed bottom-0 left-0 w-full bg-surface-50 border-t border-surface-100 flex justify-around items-center pb-safe z-30 shadow-2xl">
                <nav-button-mobile v-for="tab in tabs" :key="tab.id" :item="tab" :active="activeTab === tab.id" @click="activeTab = tab.id"></nav-button-mobile>
            </div>
        </div>
        {% endraw %}
    </div>

    <script>
        {% raw %}
        const { createApp, ref, computed, watch, onMounted } = Vue;

        // --- Components ---
        const NavButton = {
            props: ['item', 'active'],
            template: `
                <button class="flex items-center gap-3 px-4 py-3 rounded-xl transition-all duration-200 text-sm font-bold group"
                    :class="active ? 'bg-brand-600 text-white shadow-lg shadow-brand-500/20' : 'text-surface-200 hover:bg-surface-100 hover:text-white'">
                    <i :class="[item.icon, 'text-xl']"></i>
                    <span>{{ item.label }}</span>
                </button>
            `
        };

        const NavButtonMobile = {
            props: ['item', 'active'],
            template: `
                <button class="flex flex-col items-center justify-center p-3 w-full transition-all duration-200"
                    :class="active ? 'text-brand-500' : 'text-surface-200'">
                    <i :class="[item.icon, active ? 'ph-fill' : 'ph-bold', 'text-2xl mb-1']"></i>
                    <span class="text-[10px] font-bold">{{ item.label }}</span>
                </button>
            `
        };

        const KpiCard = {
            props: ['icon', 'color', 'value', 'label'],
            template: `
                <div class="bg-surface-50 p-4 rounded-2xl border border-surface-100 flex flex-col justify-between h-28 shadow-sm">
                    <div class="w-8 h-8 rounded-lg flex items-center justify-center text-white" :class="'bg-'+color+'-500'">
                        <i :class="['ph-bold', icon]"></i>
                    </div>
                    <div>
                        <div class="text-xl font-bold text-white truncate">{{ value }}</div>
                        <div class="text-[10px] font-bold text-surface-200 uppercase tracking-wide">{{ label }}</div>
                    </div>
                </div>
            `
        };

        const ActionButton = {
            props: ['icon', 'label', 'loading', 'subtext'],
            template: `
                <button class="w-full flex items-center justify-between p-3.5 rounded-xl bg-surface-100 hover:bg-surface-200 border border-surface-100 transition text-white text-sm font-bold group disabled:opacity-50" :disabled="loading">
                    <div class="flex items-center gap-3">
                        <div v-if="loading" class="animate-spin"><i class="ph-bold ph-spinner"></i></div>
                        <i v-else :class="['ph-bold', icon, 'text-surface-200 group-hover:text-white transition']"></i>
                        <div class="text-left">
                            <div>{{ label }}</div>
                            <div v-if="subtext" class="text-[10px] text-surface-200 font-normal">{{ subtext }}</div>
                        </div>
                    </div>
                    <i class="ph-bold ph-caret-right text-surface-200 group-hover:translate-x-1 transition"></i>
                </button>
            `
        };

        const ToggleSwitch = {
            props: ['modelValue', 'label'],
            emits: ['update:modelValue'],
            template: `
                <label class="flex items-center justify-between p-3 border border-surface-100 rounded-xl cursor-pointer hover:bg-surface-100 transition bg-surface-900">
                    <span class="text-sm font-bold text-white">{{ label }}</span>
                    <div class="relative inline-flex items-center">
                        <input type="checkbox" :checked="modelValue === 'true'" @change="$emit('update:modelValue', $event.target.checked ? 'true' : 'false')" class="sr-only peer">
                        <div class="w-11 h-6 bg-surface-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-brand-500"></div>
                    </div>
                </label>
            `
        };

        createApp({
            components: { NavButton, NavButtonMobile, KpiCard, ActionButton, ToggleSwitch },
            setup() {
                const authenticated = ref(false);
                const password = ref('');
                const loginError = ref('');
                const activeTab = ref('dashboard');
                
                const tabs = [
                    { id: 'dashboard', label: 'Dashboard', icon: 'ph-squares-four' },
                    { id: 'scraper', label: 'Scraper Tool', icon: 'ph-wrench' },
                    { id: 'routes', label: 'Routes', icon: 'ph-path' },
                    { id: 'data', label: 'Data', icon: 'ph-database' },
                    { id: 'settings', label: 'Settings', icon: 'ph-gear' },
                ];

                const token = ref(localStorage.getItem('adminToken') || '');
                const settings = ref({});
                const proxies = ref([]);
                const newProxies = ref('');
                const cacheCount = ref(0);
                const uptimeSeconds = ref(0);
                const seatInventory = ref([]);
                const scraperRuns = ref([]);
                
                // Jobs
                const routeJob = ref({ status: 'idle', message: '' });
                
                // Data Explorer
                const explorerMode = ref('flights');
                const explorerData = ref({ flights: {}, weather: {} });
                const expanded = ref({});

                // Manual Scraper
                const manualScrape = ref({
                    origin: '', destination: '', date: new Date().toISOString().split('T')[0],
                    loading: false, result: null, error: null
                });

                // Routes Manager
                const allRoutes = ref([]);
                const isLoadingRoutes = ref(false);
                const routeSort = ref('errors'); // 'origin' or 'errors'

                const activeProxiesCount = computed(() => proxies.value.filter(p => p.is_active).length);
                const uptimeString = computed(() => {
                    const h = Math.floor(uptimeSeconds.value / 3600);
                    const m = Math.floor((uptimeSeconds.value % 3600) / 60);
                    return `${h}h ${m}m`;
                });
                const currentTabLabel = computed(() => tabs.find(t => t.id === activeTab.value)?.label || 'Dashboard');

                const sortedRoutes = computed(() => {
                    const list = [...allRoutes.value];
                    if (routeSort.value === 'origin') {
                        list.sort((a, b) => a.origin.localeCompare(b.origin) || a.destination.localeCompare(b.destination));
                    } else {
                        // Sort by Error Count desc, then origin
                        list.sort((a, b) => b.error_count - a.error_count || a.origin.localeCompare(b.origin));
                    }
                    return list;
                });

                // Watchers
                watch(activeTab, (val) => {
                    if (val === 'data') openExplorer();
                    if (val === 'settings') fetchProxies();
                    if (val === 'routes') fetchRoutes();
                });

                // Methods
                const getHeaders = () => {
                    if (token.value) {
                        return { 'Authorization': `Bearer ${token.value}` };
                    }
                    return { 'X-Admin-Pass': password.value };
                };

                const login = async () => {
                    try {
                        const res = await axios.post('/api/admin/login', { password: password.value });
                        token.value = res.data.token;
                        localStorage.setItem('adminToken', token.value);
                        authenticated.value = true;
                        password.value = ''; // Clear password after successful login
                        fetchData();
                        // Start Loop
                        setInterval(fetchUptime, 30000);
                        fetchUptime();
                    } catch (e) {
                        loginError.value = "Access Denied";
                        setTimeout(() => loginError.value = '', 3000);
                    }
                };

                const checkAuth = async () => {
                    if (!token.value) return;
                    try {
                        await axios.get('/api/settings', { headers: getHeaders() });
                        authenticated.value = true;
                        fetchData();
                        setInterval(fetchUptime, 30000);
                        fetchUptime();
                    } catch (e) {
                        // Token expired or invalid
                        localStorage.removeItem('adminToken');
                        token.value = '';
                    }
                };

                const logout = () => {
                    authenticated.value = false;
                    password.value = '';
                    token.value = '';
                    localStorage.removeItem('adminToken');
                };

                const fetchData = async () => {
                    try {
                        const [sRes, cRes, pRes, rRes] = await Promise.all([
                            axios.get('/api/settings', { headers: getHeaders() }),
                            axios.get('/api/admin/cache_stats', { headers: getHeaders() }),
                            axios.get('/api/proxies', { headers: getHeaders() }),
                            axios.get('/api/admin/scraper_runs', { headers: getHeaders() })
                        ]);
                        settings.value = sRes.data;
                        cacheCount.value = cRes.data.total_flights;
                        proxies.value = pRes.data;
                        scraperRuns.value = rRes.data;
                    } catch(e) { console.error(e); }
                };

                const fetchScraperRuns = async () => {
                    try {
                        const res = await axios.get('/api/admin/scraper_runs', { headers: getHeaders() });
                        scraperRuns.value = res.data;
                    } catch(e) { console.error(e); }
                };

                const fetchUptime = async () => {
                    try {
                        const res = await axios.get('/api/admin/uptime');
                        uptimeSeconds.value = res.data.uptime_seconds;
                    } catch(e){}
                };

                const fetchProxies = async () => {
                    const res = await axios.get('/api/proxies', { headers: getHeaders() });
                    proxies.value = res.data;
                };

                const fetchRoutes = async () => {
                    isLoadingRoutes.value = true;
                    try {
                        const res = await axios.get('/api/admin/routes_list', { headers: getHeaders() });
                        allRoutes.value = res.data;
                    } catch(e) { console.error(e); }
                    finally { isLoadingRoutes.value = false; }
                };

                const toggleRoute = async (route) => {
                    // Optimistic UI
                    route.is_active = !route.is_active;
                    try {
                        await axios.post(`/api/admin/routes/${route.id}/toggle`, {}, { headers: getHeaders() });
                        // If turning on, reset error count in UI too
                        if (route.is_active) route.error_count = 0;
                    } catch (e) {
                        route.is_active = !route.is_active; // Revert
                        alert("Failed to toggle route");
                    }
                };

                // Actions
                const runAutoScraper = async () => {
                    if(!confirm("Start Auto Scraper?")) return;
                    await axios.post('/api/admin/run_scraper', {}, { headers: getHeaders() });
                    alert("Scraper Started in Background");
                };

                const updateRoutes = async () => {
                    const res = await axios.post('/api/update_routes', {}, { headers: getHeaders() });
                    routeJob.value = { status: 'running', message: 'Updating...' };
                    pollJob(res.data.job_id, (job) => {
                        routeJob.value = job;
                        if(job.status === 'completed') fetchData();
                    });
                };

                const triggerWeatherUpdate = async () => {
                    await axios.post('/api/admin/update_weather', {}, { headers: getHeaders() });
                    alert("Weather update started");
                };

                const rebootBackend = async () => {
                    if(!confirm("Reboot Service?")) return;
                    await axios.post('/api/admin/reboot', {}, { headers: getHeaders() });
                };

                const clearCache = async () => {
                    if(!confirm("Clear Cache?")) return;
                    await axios.post('/api/admin/clear_cache', {}, { headers: getHeaders() });
                    fetchData();
                };

                const pollJob = (id, cb) => {
                    const intv = setInterval(async () => {
                        try {
                            const res = await axios.get(`/api/jobs/${id}`);
                            cb(res.data);
                            if(res.data.status === 'completed' || res.data.status === 'failed') clearInterval(intv);
                        } catch(e) { clearInterval(intv); }
                    }, 1000);
                };

                // Scraper Tool
                const runManualScrape = async () => {
                    manualScrape.value.loading = true;
                    manualScrape.value.result = null;
                    manualScrape.value.error = null;
                    try {
                        const res = await axios.post('/api/admin/scrape_route', {
                            origin: manualScrape.value.origin,
                            destination: manualScrape.value.destination,
                            date: manualScrape.value.date
                        }, { headers: getHeaders() });
                        manualScrape.value.result = res.data;
                        fetchData(); // Update cache count
                    } catch (e) {
                        manualScrape.value.error = e.response?.data?.detail || e.message;
                    } finally {
                        manualScrape.value.loading = false;
                    }
                };

                // Explorer
                const openExplorer = async () => {
                    try {
                        const [f, w, s] = await Promise.all([
                            axios.get('/api/admin/cached_routes', { headers: getHeaders() }),
                            axios.get('/api/admin/weather_data', { headers: getHeaders() }),
                            axios.get('/api/admin/seat_inventory', { headers: getHeaders() })
                        ]);
                        explorerData.value.flights = f.data;
                        explorerData.value.weather = w.data;
                        seatInventory.value = s.data;
                    } catch(e){}
                };

                const toggleExpand = (key) => {
                    expanded.value[key] = !expanded.value[key];
                };

                const deleteDate = async (type, date) => {
                    if(!confirm(`Delete ${type} for ${date}?`)) return;
                    await axios.delete(`/api/admin/${type}/${date}`, { headers: getHeaders() });
                    openExplorer();
                };

                // Settings
                const saveSettings = async () => {
                    await axios.post('/api/settings', settings.value, { headers: getHeaders() });
                    alert("Settings Saved");
                };

                // Proxies
                const addProxies = async () => {
                    if(!newProxies.value) return;
                    await axios.post('/api/proxies', { proxies: newProxies.value }, { headers: getHeaders() });
                    newProxies.value = '';
                    fetchProxies();
                };
                const recheckProxies = async () => {
                    if(!confirm("Recheck all proxies? This runs in background.")) return;
                    await axios.post('/api/proxies/recheck', {}, { headers: getHeaders() });
                    alert("Recheck queued.");
                };
                const deleteAllProxies = async () => {
                    if(!confirm("Delete ALL?")) return;
                    await axios.delete('/api/proxies', { headers: getHeaders() });
                    fetchProxies();
                };
                const deleteProxy = async (id) => {
                    await axios.delete(`/api/proxies/${id}`, { headers: getHeaders() });
                    fetchProxies();
                };

                // Helpers
                const formatSmartTime = (iso) => {
                    if(!iso) return '-';
                    return new Date(iso).toLocaleString();
                };

                const formatDuration = (seconds) => {
                    if (!seconds) return '-';
                    const mins = Math.floor(seconds / 60);
                    const secs = Math.floor(seconds % 60);
                    return `${mins}m ${secs}s`;
                };

                // Auto-login on mount
                onMounted(() => {
                    checkAuth();
                });

                return {
                    authenticated, password, login, loginError, logout,
                    activeTab, tabs, currentTabLabel,
                    settings, proxies, cacheCount, activeProxiesCount, uptimeString,
                    seatInventory,
                    routeJob,
                    manualScrape, runManualScrape,
                    explorerMode, explorerData, expanded, toggleExpand, deleteDate,
                    allRoutes, isLoadingRoutes, sortedRoutes, fetchRoutes, toggleRoute, routeSort,
                    saveSettings,
                    runAutoScraper, updateRoutes, triggerWeatherUpdate, rebootBackend, clearCache, fetchData,
                    newProxies, addProxies, recheckProxies, deleteAllProxies, deleteProxy,
                    formatSmartTime, formatDuration,
                    scraperRuns, fetchScraperRuns
                };
            }
        }).mount('#app');
        {% endraw %}
    </script>
</body>
</html>